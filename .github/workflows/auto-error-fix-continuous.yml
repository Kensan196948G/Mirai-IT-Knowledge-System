name: ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ5åˆ†é–“éš”ãƒ»ç„¡é™ãƒ«ãƒ¼ãƒ—ï¼‰

on:
  schedule:
    # æ¯5åˆ†å®Ÿè¡Œï¼ˆGitHub Actions schedule ã¯æœ€å°1åˆ†é–“éš”ã ãŒã€5åˆ†æ¨å¥¨ï¼‰
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      max_loops:
        description: 'æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°'
        required: false
        default: '15'
        type: string
      create_issue:
        description: 'Issueä½œæˆæœ‰ç„¡'
        required: false
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆä¿®å¾©ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œã—ãªã„ï¼‰'
        required: false
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ¨©é™è¨­å®š
# git pushã‚’è¨±å¯ï¼ˆauto-repairçµæœã®ã‚³ãƒŸãƒƒãƒˆç”¨ï¼‰
permissions:
  contents: write
  issues: write

env:
  MAX_LOOPS: ${{ github.event.inputs.max_loops || '15' }}
  PYTHON_VERSION: '3.11'
  CREATE_ISSUE: ${{ github.event.inputs.create_issue || 'yes' }}
  # ãƒ†ã‚¹ãƒˆç’°å¢ƒç”¨ãƒ€ãƒŸãƒ¼APIã‚­ãƒ¼
  ANTHROPIC_API_KEY: 'test-key'
  GEMINI_API_KEY: 'test-key'
  PERPLEXITY_API_KEY: 'test-key'
  # MCPç„¡åŠ¹åŒ–
  MCP_AUTO_INIT: 'False'
  MCP_CONTEXT7_ENABLED: 'False'
  MCP_CLAUDE_MEM_ENABLED: 'False'
  MCP_GITHUB_ENABLED: 'False'
  ENVIRONMENT: 'test'

jobs:
  # ===== ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— =====
  setup:
    name: ğŸ”§ ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.run_info.outputs.run_id }}
      start_time: ${{ steps.run_info.outputs.start_time }}
    steps:
      - name: Run info
        id: run_info
        run: |
          echo "run_id=${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "start_time=$(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-autofix-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-autofix-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install psutil

      - name: Verify setup
        run: |
          python --version
          pip list | head -20
          echo "âœ… Setup complete"

  # ===== ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ— =====
  auto-fix-loop:
    name: ğŸ”„ ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      total_errors: ${{ steps.summary.outputs.total_errors }}
      total_fixes: ${{ steps.summary.outputs.total_fixes }}
      success_rate: ${{ steps.summary.outputs.success_rate }}
      overall_status: ${{ steps.summary.outputs.overall_status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Restore pip cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-autofix-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-autofix-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install psutil pytest pytest-asyncio httpx jq

      - name: Restore state from previous run
        id: restore_state
        uses: actions/download-artifact@v4
        with:
          name: auto-fix-state
          path: .
        continue-on-error: true

      - name: Check state and decide execution
        id: check_state
        run: |
          if [ -f state.json ]; then
            echo "ğŸ“‹ Previous state found"
            cat state.json | jq '.'

            # state.json ã‹ã‚‰ retry_required ã‚’èª­ã¿å–ã‚Š
            retry_required=$(jq -r '.retry_required // true' state.json)
            run_count=$(jq -r '.run_count // 0' state.json)
            cooldown_until=$(jq -r '.cooldown_until // ""' state.json)

            echo "retry_required=$retry_required" >> $GITHUB_OUTPUT
            echo "run_count=$run_count" >> $GITHUB_OUTPUT
            echo "cooldown_until=$cooldown_until" >> $GITHUB_OUTPUT

            # ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æœŸé–“ãƒã‚§ãƒƒã‚¯
            if [ -n "$cooldown_until" ]; then
              current_time=$(date -u +%s)
              cooldown_time=$(date -u -d "$cooldown_until" +%s 2>/dev/null || echo "0")

              if [ "$current_time" -lt "$cooldown_time" ]; then
                echo "â¸ï¸  In cooldown period until $cooldown_until"
                echo "should_run=false" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi

            # retry_required ãŒ false ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
            if [ "$retry_required" = "false" ]; then
              echo "âœ… No retry required (system healthy)"
              echo "should_run=false" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  Retry required (errors detected)"
              echo "should_run=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "ğŸ“‹ No previous state, starting fresh"
            echo "retry_required=true" >> $GITHUB_OUTPUT
            echo "run_count=0" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

      - name: Prepare environment
        if: steps.check_state.outputs.should_run != 'false'
        run: |
          mkdir -p db logs backups data/knowledge certs

          # ãƒ†ã‚¹ãƒˆç”¨DBä½œæˆ
          python -c "
          import sqlite3
          conn = sqlite3.connect('db/knowledge.db')
          cursor = conn.cursor()
          cursor.execute('''CREATE TABLE IF NOT EXISTS knowledge (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              title TEXT NOT NULL,
              content TEXT,
              itsm_type TEXT,
              created_by TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          )''')
          conn.commit()
          conn.close()
          print('âœ… Test database initialized')
          "

          # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«åˆæœŸåŒ–
          echo "# Auto-fix log started at $(date)" > logs/app.log
          echo "# Auto-fix log started at $(date)" > logs/auto_fix.log

      - name: Run health check
        if: steps.check_state.outputs.should_run != 'false'
        id: health_check
        run: |
          cd $GITHUB_WORKSPACE
          python scripts/health_monitor.py --json > health_result.json || true
          cat health_result.json

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã‚’è§£æ
          if python -c "import json; data=json.load(open('health_result.json')); exit(0 if data.get('overall_status') == 'healthy' else 1)" 2>/dev/null; then
            echo "health_status=healthy" >> $GITHUB_OUTPUT
          else
            echo "health_status=degraded" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run unit tests
        if: steps.check_state.outputs.should_run != 'false'
        id: unit_tests
        run: |
          cd $GITHUB_WORKSPACE
          python -m pytest tests/ -v --tb=short -x 2>&1 | tee test_result.txt || true

          # ãƒ†ã‚¹ãƒˆçµæœã‚’è§£æ
          if grep -q "passed" test_result.txt && ! grep -q "failed\|error" test_result.txt; then
            echo "test_status=passed" >> $GITHUB_OUTPUT
          else
            echo "test_status=failed" >> $GITHUB_OUTPUT
            # ãƒ†ã‚¹ãƒˆå¤±æ•—ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
            echo "$(date) - [ERROR] - Unit tests failed" >> logs/app.log
          fi
        continue-on-error: true

      - name: Run error detection loop
        if: steps.check_state.outputs.should_run != 'false'
        id: detection_loop
        run: |
          cd $GITHUB_WORKSPACE

          echo "ğŸ”„ Starting error detection loop (max 3 cycles for CI)"

          # æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œï¼ˆCIç’°å¢ƒã§ã¯3å›ã«åˆ¶é™ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ5åˆ†ï¼‰
          timeout 300 python scripts/auto_fix_daemon.py --once 2>&1 | tee auto_fix_output.txt || true

          echo "âœ… Detection loop completed"
        continue-on-error: true
        timeout-minutes: 5

      - name: Generate summary
        if: steps.check_state.outputs.should_run != 'false'
        id: summary
        run: |
          cd $GITHUB_WORKSPACE

          # çµæœã‚’é›†è¨ˆï¼ˆæ”¹è¡Œã‚’é™¤å»ï¼‰
          total_errors=$(grep -c "ã‚¨ãƒ©ãƒ¼æ¤œå‡º\|Detected.*errors\|ERROR" auto_fix_output.txt 2>/dev/null | tr -d '\n' || echo "0")
          total_fixes=$(grep -c "ä¿®å¾©ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ\|Fixed:\|Action.*success" auto_fix_output.txt 2>/dev/null | tr -d '\n' || echo "0")

          # æ•°å€¤ã«å¤‰æ›ï¼ˆç©ºã®å ´åˆã¯0ï¼‰
          total_errors=${total_errors:-0}
          total_fixes=${total_fixes:-0}

          # æˆåŠŸç‡è¨ˆç®—
          if [ "$total_errors" -gt 0 ] 2>/dev/null; then
            success_rate=$((total_fixes * 100 / total_errors))
          else
            success_rate=100
          fi

          # å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
          health_status="${{ steps.health_check.outputs.health_status }}"
          test_status="${{ steps.unit_tests.outputs.test_status }}"

          if [ "$health_status" = "healthy" ] && [ "$test_status" = "passed" ]; then
            overall_status="healthy"
          elif [ "$total_errors" -gt 0 ] 2>/dev/null && [ "$success_rate" -lt 50 ] 2>/dev/null; then
            overall_status="critical"
          else
            overall_status="degraded"
          fi

          echo "total_errors=$total_errors" >> $GITHUB_OUTPUT
          echo "total_fixes=$total_fixes" >> $GITHUB_OUTPUT
          echo "success_rate=$success_rate" >> $GITHUB_OUTPUT
          echo "overall_status=$overall_status" >> $GITHUB_OUTPUT

          echo "ğŸ“Š Summary:"
          echo "   Total errors detected: $total_errors"
          echo "   Total fixes applied: $total_fixes"
          echo "   Success rate: $success_rate%"
          echo "   Overall status: $overall_status"

      - name: Upload logs artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: auto-fix-logs-${{ github.run_id }}
          path: |
            logs/
            auto_fix_output.txt
            health_result.json
            test_result.txt
          retention-days: 30

      - name: Save state for next run
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: auto-fix-state
          path: state.json
          retention-days: 7
          overwrite: true

  # ===== ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ =====
  report:
    name: ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    runs-on: ubuntu-latest
    needs: [setup, auto-fix-loop]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate markdown report
        id: report
        run: |
          cat << 'EOF' > report.md
          # ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ  ãƒ¬ãƒãƒ¼ãƒˆ

          ## ğŸ“‹ å®Ÿè¡Œæƒ…å ±
          | é …ç›® | å€¤ |
          |------|-----|
          | **Run ID** | ${{ needs.setup.outputs.run_id }} |
          | **é–‹å§‹æ™‚åˆ»** | ${{ needs.setup.outputs.start_time }} |
          | **çµ‚äº†æ™‚åˆ»** | $(date -u '+%Y-%m-%dT%H:%M:%SZ') |
          | **ãƒ«ãƒ¼ãƒ—å›æ•°** | ${{ env.MAX_LOOPS }} |
          | **ãƒˆãƒªã‚¬ãƒ¼** | ${{ github.event_name }} |

          ## ğŸ“Š å®Ÿè¡Œçµæœ
          | æŒ‡æ¨™ | å€¤ |
          |------|-----|
          | **æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°** | ${{ needs.auto-fix-loop.outputs.total_errors }} |
          | **ä¿®å¾©è©¦è¡Œæ•°** | ${{ needs.auto-fix-loop.outputs.total_fixes }} |
          | **æˆåŠŸç‡** | ${{ needs.auto-fix-loop.outputs.success_rate }}% |
          | **å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** | ${{ needs.auto-fix-loop.outputs.overall_status }} |

          ## ğŸ” è©³ç´°

          ### ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ
          - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å®Ÿè¡Œæ¸ˆã¿

          ### ãƒ†ã‚¹ãƒˆçµæœ
          - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å®Ÿè¡Œæ¸ˆã¿

          ---
          *ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          *Workflow: ${{ github.workflow }}*
          EOF

          cat report.md
          echo "report_generated=true" >> $GITHUB_OUTPUT

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: auto-fix-report-${{ github.run_id }}
          path: report.md
          retention-days: 30

      - name: Add summary to job
        run: |
          cat report.md >> $GITHUB_STEP_SUMMARY

  # ===== Issue ä½œæˆï¼ˆã‚¨ãƒ©ãƒ¼æ¤œå‡ºæ™‚ï¼‰ =====
  create-issue:
    name: ğŸ“Œ Issue ä½œæˆ
    runs-on: ubuntu-latest
    needs: [setup, auto-fix-loop, report]
    if: |
      always() &&
      needs.auto-fix-loop.outputs.overall_status != 'healthy' &&
      (github.event.inputs.create_issue == 'yes' || github.event.inputs.create_issue == '')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create issue for critical errors
        uses: actions/github-script@v7
        with:
          script: |
            const totalErrors = '${{ needs.auto-fix-loop.outputs.total_errors }}';
            const totalFixes = '${{ needs.auto-fix-loop.outputs.total_fixes }}';
            const successRate = '${{ needs.auto-fix-loop.outputs.success_rate }}';
            const overallStatus = '${{ needs.auto-fix-loop.outputs.overall_status }}';
            const runId = '${{ needs.setup.outputs.run_id }}';

            // æ—¢å­˜ã®åŒæ§˜ã®Issueã‚’æ¤œç´¢
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'auto-fix,bot',
              state: 'open',
              per_page: 5
            });

            // 24æ™‚é–“ä»¥å†…ã®åŒæ§˜ã®IssueãŒã‚ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
            const recentIssue = existingIssues.data.find(issue => {
              const createdAt = new Date(issue.created_at);
              const now = new Date();
              const hoursDiff = (now - createdAt) / (1000 * 60 * 60);
              return hoursDiff < 24;
            });

            if (recentIssue) {
              console.log(`Similar issue exists: #${recentIssue.number}, skipping...`);

              // æ—¢å­˜Issueã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: recentIssue.number,
                body: `## ğŸ”„ è‡ªå‹•æ¤œçŸ¥æ›´æ–° (Run #${runId})

            | æŒ‡æ¨™ | å€¤ |
            |------|-----|
            | æ¤œå‡ºã‚¨ãƒ©ãƒ¼ | ${totalErrors} |
            | ä¿®å¾©è©¦è¡Œ | ${totalFixes} |
            | æˆåŠŸç‡ | ${successRate}% |
            | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ${overallStatus} |

            [è©³ç´°ãƒ­ã‚°](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId})`
              });
              return;
            }

            // æ–°è¦Issueä½œæˆ
            const statusEmoji = overallStatus === 'critical' ? 'ğŸ”´' : 'ğŸŸ¡';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${statusEmoji} [Auto-Fix] ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ (${new Date().toISOString().split('T')[0]})`,
              body: `## ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ  ãƒ¬ãƒãƒ¼ãƒˆ

            ### ğŸ“Š æ¤œçŸ¥çµæœ
            | æŒ‡æ¨™ | å€¤ |
            |------|-----|
            | **æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°** | ${totalErrors} |
            | **ä¿®å¾©è©¦è¡Œæ•°** | ${totalFixes} |
            | **æˆåŠŸç‡** | ${successRate}% |
            | **å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** | ${overallStatus} |

            ### ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯
            - [GitHub Actions ãƒ­ã‚°](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId})

            ### ğŸ“ å¯¾å¿œæ–¹æ³•
            1. ä¸Šè¨˜ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’æŠŠæ¡
            2. è‡ªå‹•ä¿®å¾©ã§è§£æ±ºã§ããªã‹ã£ãŸå•é¡Œã‚’æ‰‹å‹•ã§å¯¾å¿œ
            3. å¯¾å¿œå®Œäº†å¾Œã€ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º

            ---
            *ã“ã®Issueã¯è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸ*`,
              labels: ['auto-fix', 'bot', overallStatus === 'critical' ? 'priority:high' : 'priority:medium']
            });

  # ===== å®Œäº†é€šçŸ¥ =====
  notify:
    name: âœ… å®Œäº†é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [setup, auto-fix-loop, report, create-issue]
    if: always()
    steps:
      - name: Final summary
        run: |
          echo "## ğŸ è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ  å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | çµæœ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— | ${{ needs.setup.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ— | ${{ needs.auto-fix-loop.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ | ${{ needs.report.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Issueä½œæˆ | ${{ needs.create-issue.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status**: ${{ needs.auto-fix-loop.outputs.overall_status }}" >> $GITHUB_STEP_SUMMARY

