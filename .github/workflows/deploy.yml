name: Deploy to Production

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/FUNDING.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ===== Pre-deployment Checks =====
  pre-deploy:
    name: ðŸ” Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check deployment conditions
        id: check
        run: |
          # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒžãƒ¼ã‚¸æ™‚ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Manual deployment triggered"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Auto deployment to production"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "Skipping deployment"
          fi

      - name: Verify CI passed
        run: |
          echo "Checking if CI workflow passed..."
          # CIçµæžœã®ç¢ºèªï¼ˆGitHub CLIä½¿ç”¨ï¼‰
          # gh run list --workflow=ci.yml --branch=main --status=success --limit=1

  # ===== Build Artifacts =====
  build:
    name: ðŸ“¦ Build Artifacts
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: needs.pre-deploy.outputs.should_deploy == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create deployment package
        run: |
          # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ
          mkdir -p dist

          # å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
          tar -czvf dist/mirai-knowledge-system.tar.gz \
            --exclude='*.pyc' \
            --exclude='__pycache__' \
            --exclude='.git' \
            --exclude='tests' \
            --exclude='*.log' \
            --exclude='.env*' \
            --exclude='certs/*' \
            --exclude='db/*.db' \
            --exclude='backups' \
            --exclude='dist' \
            src/ \
            scripts/ \
            db/schema.sql \
            db/feedback_schema.sql \
            requirements.txt \
            start.sh

          echo "Package created: $(ls -lh dist/mirai-knowledge-system.tar.gz)"

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: dist/mirai-knowledge-system.tar.gz
          retention-days: 7

  # ===== Deploy to Server =====
  deploy:
    name: ðŸš€ Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ vars.DEPLOY_URL }}
    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: dist/

      - name: Deploy notification start
        run: |
          echo "## ðŸš€ Deployment Started" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      # ä»¥ä¸‹ã¯å®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
      # SSHçµŒç”±ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ä¾‹ï¼ˆè¦secretsè¨­å®šï¼‰
      # - name: Deploy to server
      #   uses: appleboy/ssh-action@v1.0.0
      #   with:
      #     host: ${{ secrets.DEPLOY_HOST }}
      #     username: ${{ secrets.DEPLOY_USER }}
      #     key: ${{ secrets.DEPLOY_SSH_KEY }}
      #     script: |
      #       cd /opt/mirai-knowledge-system
      #       ./scripts/deploy.sh

      - name: Simulate deployment (placeholder)
        run: |
          echo "ðŸ“¦ Deploying package..."
          echo "Package size: $(ls -lh dist/mirai-knowledge-system.tar.gz | awk '{print $5}')"
          echo ""
          echo "âš ï¸  Note: Actual deployment requires server configuration."
          echo "    Configure the following secrets in GitHub repository settings:"
          echo "    - DEPLOY_HOST: Target server hostname"
          echo "    - DEPLOY_USER: SSH username"
          echo "    - DEPLOY_SSH_KEY: SSH private key"
          echo ""
          echo "âœ… Deployment simulation completed"

  # ===== Post-deployment Verification =====
  verify:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Health check
        run: |
          echo "## Health Check" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "Deployment verification would check:"
          echo "- Application health endpoint"
          echo "- Database connectivity"
          echo "- AI services availability"
          echo ""
          echo "Configure DEPLOY_URL in environment variables for actual checks."

      - name: Deployment summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Actor: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # ===== Rollback (Manual Trigger) =====
  rollback:
    name: âª Rollback
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch'
    needs: [deploy, verify]
    steps:
      - name: Rollback notification
        run: |
          echo "âš ï¸ Deployment failed. Initiating rollback..."
          echo ""
          echo "## âª Rollback Required" >> $GITHUB_STEP_SUMMARY
          echo "Deployment failed. Manual intervention may be required." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Steps to rollback:" >> $GITHUB_STEP_SUMMARY
          echo "1. SSH to production server" >> $GITHUB_STEP_SUMMARY
          echo "2. Run: \`./scripts/rollback.sh\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify application status" >> $GITHUB_STEP_SUMMARY
