name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  # ãƒ†ã‚¹ãƒˆç’°å¢ƒç”¨ã®ãƒ€ãƒŸãƒ¼APIã‚­ãƒ¼
  ANTHROPIC_API_KEY: 'test-key'
  GEMINI_API_KEY: 'test-key'
  PERPLEXITY_API_KEY: 'test-key'
  # MCPç„¡åŠ¹åŒ–
  MCP_AUTO_INIT: 'False'
  MCP_CONTEXT7_ENABLED: 'False'
  MCP_CLAUDE_MEM_ENABLED: 'False'
  MCP_GITHUB_ENABLED: 'False'

jobs:
  # ===== Linting Job =====
  lint:
    name: ðŸ” Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-lint-

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort

      - name: Check code formatting with Black
        run: |
          black --check --diff src/ tests/ || echo "::warning::Code formatting issues found. Run 'black src/ tests/' to fix."

      - name: Check import sorting with isort
        run: |
          isort --check-only --diff src/ tests/ || echo "::warning::Import sorting issues found. Run 'isort src/ tests/' to fix."

      - name: Lint with flake8
        run: |
          # E501: line too long (è¨±å®¹)
          # W503: line break before binary operator (è¨±å®¹)
          # E203: whitespace before ':' (blackäº’æ›)
          flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src/ tests/ --count --exit-zero --max-line-length=120 --ignore=E501,W503,E203 --statistics

  # ===== Unit Tests Job =====
  test:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: Set up test environment
        run: |
          mkdir -p db logs
          export ENVIRONMENT=test

      - name: Run unit tests with coverage
        run: |
          python -m pytest tests/ -v --tb=short \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-fail-under=30
        env:
          ENVIRONMENT: test
          DATABASE_PATH: ./db/test.db
          LOG_PATH: ./logs
          LOG_FILE: test.log

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.11'
        with:
          name: coverage-report
          path: coverage.xml

  # ===== Security Scan Job =====
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Run Bandit security scan
        run: |
          # B101: assertä½¿ç”¨ (ãƒ†ã‚¹ãƒˆã§ã¯è¨±å®¹)
          # B104: hardcoded_bind_all_interfaces (é–‹ç™ºç’°å¢ƒã§ã¯è¨±å®¹)
          # B608: SQL injection (false positive - validated identifiers)
          # B310: urllib.urlopen (false positive - fixed URLs)
          bandit -r src/ -ll --skip B101,B104,B608,B310 -f json -o bandit-report.json || true
          bandit -r src/ -ll --skip B101,B104,B608,B310

      - name: Check dependencies for vulnerabilities
        run: |
          pip install -r requirements.txt
          safety check --full-report || echo "::warning::Vulnerability found in dependencies"
        continue-on-error: true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: bandit-report.json

  # ===== Integration Tests Job =====
  integration:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Set up test database
        run: |
          mkdir -p db logs
          python -c "
          import sqlite3
          conn = sqlite3.connect('db/test.db')
          cursor = conn.cursor()
          # åŸºæœ¬ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
          cursor.execute('''CREATE TABLE IF NOT EXISTS knowledge (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              title TEXT NOT NULL,
              content TEXT,
              itsm_type TEXT,
              created_by TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          )''')
          cursor.execute('''CREATE TABLE IF NOT EXISTS conversation_sessions (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              session_id TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          )''')
          conn.commit()
          conn.close()
          print('Test database initialized')
          "

      - name: Run API integration tests
        run: |
          python -m pytest tests/test_api_integration.py -v --tb=short
        env:
          ENVIRONMENT: test
          DATABASE_PATH: ./db/test.db
          LOG_PATH: ./logs
          LOG_FILE: test.log

      - name: Run workflow integration tests
        run: |
          python -m pytest tests/test_workflow_integration.py -v --tb=short
        env:
          ENVIRONMENT: test

  # ===== Build Check Job =====
  build:
    name: ðŸ“¦ Build Check
    runs-on: ubuntu-latest
    needs: [test, security]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify application startup
        run: |
          mkdir -p db logs certs
          # è‡ªå·±ç½²åè¨¼æ˜Žæ›¸ç”Ÿæˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
          openssl req -x509 -newkey rsa:2048 -keyout certs/dev-key.pem -out certs/dev-cert.pem -days 1 -nodes -subj "/CN=localhost" 2>/dev/null

          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
          python -c "
          import os
          os.environ['ENVIRONMENT'] = 'test'
          os.environ['DATABASE_PATH'] = 'db/test.db'
          os.environ['MCP_AUTO_INIT'] = 'False'
          os.environ['MCP_CONTEXT7_ENABLED'] = 'False'
          os.environ['MCP_CLAUDE_MEM_ENABLED'] = 'False'
          os.environ['MCP_GITHUB_ENABLED'] = 'False'

          # ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
          from src.core.itsm_classifier import ITSMClassifier
          from src.core.workflow import WorkflowEngine
          print('âœ… Core modules imported successfully')

          # AIã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
          from src.ai.orchestrator import AIOrchestrator
          print('âœ… AI orchestrator imported successfully')

          # Flaskã‚¢ãƒ—ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
          import io, contextlib
          with contextlib.redirect_stdout(io.StringIO()), contextlib.redirect_stderr(io.StringIO()):
              from src.webui.app import app
          print('âœ… Flask application imported successfully')
          "
        env:
          ANTHROPIC_API_KEY: 'test-key'
          GEMINI_API_KEY: 'test-key'
          PERPLEXITY_API_KEY: 'test-key'

      - name: Build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Python Version: ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- All modules imported successfully" >> $GITHUB_STEP_SUMMARY
          echo "- Ready for deployment" >> $GITHUB_STEP_SUMMARY

  # ===== Status Check Job =====
  status:
    name: âœ… CI Status
    runs-on: ubuntu-latest
    needs: [lint, test, security, integration, build]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.lint.result }}" == "failure" ] || \
             [ "${{ needs.test.result }}" == "failure" ] || \
             [ "${{ needs.integration.result }}" == "failure" ] || \
             [ "${{ needs.build.result }}" == "failure" ]; then
            echo "âŒ CI Pipeline failed"
            exit 1
          else
            echo "âœ… CI Pipeline passed"
          fi

      - name: Generate summary
        run: |
          echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
