#!/usr/bin/env python3
"""
サンプルデータ生成スクリプト
実際の運用を想定したインシデント・問題管理データを生成
"""

import sys
from pathlib import Path
from datetime import datetime, timedelta

# プロジェクトルートをパスに追加
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from src.core.workflow import WorkflowEngine
from src.core.itsm_classifier import ITSMClassifier


# 実際の運用データサンプル
SAMPLE_DATA = [
    {
        "title": "データベース接続タイムアウトエラー",
        "content": """
## 発生事象
2025-12-30 14:23:45 本番環境のデータベース接続でタイムアウトエラーが多発。
複数のアプリケーションサーバーから同時にエラーが報告された。

## 影響範囲
- 影響システム: 在庫管理システム、受注システム
- 影響ユーザー: 約200名
- 影響時間: 14:23〜15:10（約47分間）

## 初動対応
1. 14:25 監視システムからアラート受信
2. 14:28 データベースサーバーの状態確認
3. 14:30 接続数が上限（max_connections=100）に到達していることを確認
4. 14:35 一時対応として max_connections を 200 に変更
5. 14:40 データベース再起動
6. 14:50 サービス復旧確認
7. 15:10 全システムの正常性確認完了

## エラーログ
```
2025-12-30 14:23:45 [ERROR] Connection timeout: SQLSTATE[HY000] [2002]
2025-12-30 14:23:47 [ERROR] Too many connections (max_connections=100)
```

## 一時対応
max_connections パラメータを 100 → 200 に変更してデータベースを再起動

## 今後の対応
- 根本原因調査（問題管理へエスカレーション）
- コネクションプール設定の見直し
- 接続数監視アラートの設定
""",
        "itsm_type": "Incident",
        "created_by": "ops_team"
    },
    {
        "title": "データベース接続数上限問題の根本原因分析",
        "content": """
## 関連インシデント
- INC-2025-003: データベース接続タイムアウトエラー

## 根本原因
アプリケーション側のコネクションプール設定が不適切で、接続が解放されずに蓄積していた。

### 詳細分析
1. **コネクションプール設定の問題**
   - アプリケーションサーバー: 10台
   - 各サーバーのプール最大接続数: 20
   - 合計最大接続数: 200（理論値）
   - データベース側上限: 100

2. **接続リーク**
   - 例外発生時に接続が正しくクローズされないケースを確認
   - 長時間実行されるバッチ処理が接続を保持したまま

3. **監視不足**
   - データベース接続数の監視が未設定
   - アプリケーション側のプール使用状況が可視化されていない

## 恒久対策
1. **アプリケーション修正**
   - try-finally ブロックで確実に接続をクローズ
   - コネクションプールタイムアウト設定の追加
   - プール最大接続数を適切に調整（各サーバー10接続）

2. **データベース設定最適化**
   - max_connections を 150 に設定（余裕を持たせる）
   - connection_timeout 設定の追加

3. **監視強化**
   - データベース接続数監視（80%でwarning、90%でcritical）
   - アプリケーションプール使用率監視
   - スロークエリ検知

4. **運用改善**
   - 定期的な接続数レビュー
   - バッチ処理の実行時間帯見直し

## 再発防止
- コードレビューで接続処理を重点チェック
- 月次でデータベース接続状況をレポート
- 負荷テスト時に接続数を確認

## 実施計画
恒久対策を変更管理として実施（CHG-2025-005）
実施予定日: 2026-01-15
""",
        "itsm_type": "Problem",
        "created_by": "dev_team"
    },
    {
        "title": "Webサーバー証明書の更新作業",
        "content": """
## 変更内容
本番Webサーバー（3台）のSSL/TLS証明書を更新する。
現在の証明書が2026-01-31に期限切れとなるため、事前に更新を実施。

## 対象システム
- web-prod-01.example.com
- web-prod-02.example.com
- web-prod-03.example.com

## 作業手順
1. 新規証明書の取得（Let's Encrypt）
2. ステージング環境での動作確認
3. 本番環境への適用
   - web-prod-01 での適用とテスト
   - 問題なければ web-prod-02, 03 へ順次適用
4. ブラウザでの証明書確認
5. 監視アラートの確認

## 作業時間
- 予定日時: 2026-01-10 02:00-04:00（メンテナンス時間帯）
- 所要時間: 約1時間（予備含め2時間確保）

## リスク評価
- **リスクレベル**: 中
- **影響度**: ユーザーアクセスへの影響なし（証明書切り替えは即座）
- **可能性**: 低（ステージングで事前確認済み）

## ロールバック計画
新証明書で問題が発生した場合、旧証明書に即座に切り戻し可能。
旧証明書のバックアップを保持（期限: 2026-01-31まで）

## テスト計画
1. ステージング環境での事前テスト（完了）
2. 本番環境での段階的適用
3. 各種ブラウザでの接続確認
4. SSL Labs でのセキュリティ評価確認

## 承認
- 申請者: インフラチーム
- 承認者: システム管理者
- 承認日: 2026-01-05
""",
        "itsm_type": "Change",
        "created_by": "infra_team"
    },
    {
        "title": "APIレート制限機能のリリース",
        "content": """
## リリース概要
外部APIに対するレート制限機能を実装し、本番環境にリリースする。

## リリース内容
- バージョン: v2.3.0
- 機能: APIレート制限（IP単位、ユーザー単位）
- リリース日時: 2026-01-20 21:00

## 新機能
1. **IPベースレート制限**
   - 制限: 1000リクエスト/時間
   - 超過時: HTTP 429 (Too Many Requests)

2. **ユーザーベースレート制限**
   - 無料プラン: 100リクエスト/時間
   - 有料プラン: 10000リクエスト/時間

3. **管理画面**
   - レート制限状況の可視化
   - 個別ユーザーの制限解除機能

## リリース手順
1. データベースマイグレーション実行
2. アプリケーションサーバーの順次更新（Blue-Green デプロイ）
3. レート制限設定の適用
4. 動作確認

## 影響分析
- **ユーザー影響**: 既存ユーザーは影響なし（制限値は現在の利用状況より十分に高い）
- **システム負荷**: Redis 使用によるわずかなオーバーヘッド（<5ms/request）

## ロールバック手順
1. レート制限機能を無効化（設定変更）
2. 必要に応じて旧バージョンへロールバック

## 事前準備
- ✅ ステージング環境でのテスト完了
- ✅ 負荷テスト実施（問題なし）
- ✅ ドキュメント更新
- ✅ ユーザー通知（1週間前）

## リリース後の確認項目
- [ ] APIレスポンスタイムの監視
- [ ] エラーレートの確認
- [ ] Redis 接続状況の監視
- [ ] ユーザーからの問い合わせ対応
""",
        "itsm_type": "Release",
        "created_by": "dev_team"
    },
    {
        "title": "新規ユーザーのVPNアクセス権限申請",
        "content": """
## 申請内容
新規入社社員に対するVPNアクセス権限の付与を申請します。

## 申請者情報
- 申請者: 人事部 田中
- 申請日: 2026-01-08

## 対象ユーザー
- 氏名: 山田太郎
- 社員番号: EMP-2026-001
- 部署: 開発部
- 入社日: 2026-01-15

## 必要なアクセス権限
1. **VPN接続**
   - 接続プロトコル: SSL-VPN
   - アクセス範囲: 開発環境セグメント

2. **アクセス可能リソース**
   - 開発用サーバー（dev-server-01〜05）
   - Git リポジトリサーバー
   - 開発用データベース

3. **利用期間**
   - 開始日: 2026-01-15
   - 終了日: 無期限（退職まで）

## セキュリティ要件
- 多要素認証（MFA）必須
- パスワードポリシー準拠
- 定期的なパスワード変更（90日ごと）

## 承認フロー
1. 直属上長承認: ✅ 完了（2026-01-08）
2. 情報セキュリティ部門承認: 待機中
3. システム管理者による設定: 承認後実施

## 作業内容
1. ADアカウント作成
2. VPN証明書発行
3. アクセス権限設定
4. MFA設定支援
5. 利用マニュアル送付

## 期限
入社日（2026-01-15）までに設定完了必須
""",
        "itsm_type": "Request",
        "created_by": "hr_tanaka"
    },
    {
        "title": "バックアップサーバーのディスク容量逼迫",
        "content": """
## 発生事象
2026-01-09 08:00 バックアップサーバーのディスク使用率が95%に到達。
監視システムからアラートが発報された。

## 影響範囲
- 影響システム: バックアップサーバー（backup-srv-01）
- 緊急度: 高（ディスク満杯時はバックアップ失敗のリスク）
- 現在の状態: バックアップは継続動作中

## ディスク使用状況
```
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1       2.0T  1.9T  100G  95% /backup
```

## 対応内容
1. 08:05 アラート確認
2. 08:10 古いバックアップファイルの確認
3. 08:20 90日以前のバックアップを削除（ポリシー: 90日保持）
4. 08:45 ディスク容量確保完了（使用率: 75%）
5. 09:00 バックアップ処理の正常動作確認

## 削除されたバックアップ
- 対象期間: 2025-10-01 以前
- 削除容量: 約400GB
- 現在の空き容量: 500GB

## 一時対応
古いバックアップファイルの削除により空き容量を確保

## 恒久対策
1. バックアップストレージの増設検討
2. バックアップ世代管理の自動化
3. 容量監視アラートの閾値見直し（90%→85%）
4. 定期的な容量レビュープロセスの確立

## 今後の対応
- ストレージ増設計画の立案
- バックアップポリシーの見直し
""",
        "itsm_type": "Incident",
        "created_by": "ops_team"
    },
    {
        "title": "メール送信遅延の継続的な問題",
        "content": """
## 問題概要
過去3ヶ月間で、メール送信遅延のインシデントが15件発生。
断続的に発生しており、根本的な解決が必要。

## 関連インシデント
- INC-2025-087, 092, 101, 115, 128...（計15件）
- 発生パターン: 月曜午前、月末、給料日後など

## 影響
- 遅延時間: 5分〜30分
- 影響ユーザー: 全社員（約500名）
- ビジネスインパクト: 顧客対応の遅延、業務効率の低下

## 現在の対応
各インシデント発生時にメールキューのクリアで対応しているが、
根本的な解決には至っていない。

## 根本原因調査
### 1. メールサーバーのリソース不足
- CPU使用率が高い時間帯と遅延が相関
- メモリ使用率も80%超えることが多い

### 2. スパムチェック処理のボトルネック
- SpamAssassin による全メールスキャンが負荷
- 大量メール送信時に処理が追いつかない

### 3. ネットワーク帯域
- 朝のピーク時にネットワーク使用率が高い
- 他システムとの帯域競合

## 恒久対策案
### 案1: メールサーバーのスケールアップ
- メリット: 即効性がある
- デメリット: コスト増、根本解決ではない
- 費用: 約50万円/年

### 案2: クラウドメールサービスへの移行
- メリット: スケーラビリティ、保守不要
- デメリット: 初期移行コスト、セキュリティ検討必要
- 費用: 約100万円（初期）+ 30万円/年

### 案3: メールキュー管理の最適化
- メリット: 低コスト
- デメリット: 効果が限定的
- 費用: 開発工数のみ

## 推奨案
**案2: クラウドメールサービスへの移行**を推奨
- 長期的なコスト削減
- 可用性・拡張性の向上
- 運用負荷の軽減

## 実施計画
1. PoC実施（1ヶ月）
2. 移行計画策定（1ヶ月）
3. 段階的移行（3ヶ月）
4. 完全移行（6ヶ月後目標）

## 承認待ち
経営層への提案待ち（予算承認必要）
""",
        "itsm_type": "Problem",
        "created_by": "infra_team"
    }
]


def main():
    """サンプルデータを生成"""
    print("🌸 Mirai IT Knowledge Systems - サンプルデータ生成")
    print("=" * 80)

    engine = WorkflowEngine()
    classifier = ITSMClassifier()

    created_count = 0
    failed_count = 0

    for i, data in enumerate(SAMPLE_DATA, 1):
        print(f"\n[{i}/{len(SAMPLE_DATA)}] {data['title']}")
        print("-" * 80)

        try:
            # ワークフロー実行
            result = engine.process_knowledge(
                title=data['title'],
                content=data['content'],
                itsm_type=data['itsm_type'],
                created_by=data['created_by']
            )

            if result['success']:
                created_count += 1
                print(f"✅ 成功: ナレッジID {result['knowledge_id']}")
                print(f"   実行時間: {result['execution_time_ms']}ms")
                print(f"   品質スコア: {result['post_task_assessment'].get('quality_score', 0):.0%}")
            else:
                failed_count += 1
                print(f"❌ 失敗: {result.get('error')}")

        except Exception as e:
            failed_count += 1
            print(f"❌ エラー: {str(e)}")

    print("\n" + "=" * 80)
    print(f"📊 生成結果:")
    print(f"   成功: {created_count}件")
    print(f"   失敗: {failed_count}件")
    print(f"   合計: {len(SAMPLE_DATA)}件")
    print("\n✨ サンプルデータ生成完了！")


if __name__ == "__main__":
    main()
