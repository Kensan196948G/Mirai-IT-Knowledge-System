{% extends "base.html" %}

{% block title %}Server Faultè³ªå•ãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚° - Mirai IT Knowledge Systems{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ’¬ Server Faultè³ªå•ãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°</h2>
    <p>Server Faultã‹ã‚‰å–å¾—ã—ãŸè³ªå•ã‚’æ—¥æœ¬èªã§è¡¨ç¤ºã—ã¾ã™ã€‚</p>
</div>

<div class="card" style="margin-bottom: 1.5rem;">
    <form id="searchForm" role="search" onsubmit="performSearch(event)">
        <div style="display: flex; gap: 0.75rem; align-items: center;">
            <input type="search" id="searchInput" placeholder="ä¾‹: Apache 503" style="flex: 1; height: 48px; font-size: 1rem; padding: 0.75rem 0.9rem;" />
            <button class="btn" type="submit">æ¤œç´¢</button>
        </div>
        <p style="color: #666; margin-top: 0.5rem;">æ—¥æœ¬èªã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã§ãã¾ã™ã€‚</p>
    </form>
</div>

<div style="display: grid; grid-template-columns: minmax(220px, 260px) 1fr; gap: 1.5rem;">
    <aside class="card" style="height: fit-content;">
        <h3 style="margin-bottom: 0.75rem;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
        <div style="margin-bottom: 1rem;">
            <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</strong>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                <label><input type="checkbox" name="status" value="answered" checked> å›ç­”æ¸ˆã¿</label>
                <label><input type="checkbox" name="status" value="unanswered" checked> æœªå›ç­”</label>
                <label><input type="checkbox" name="status" value="accepted" checked> è§£æ±ºæ¸ˆã¿</label>
            </div>
        </div>
        <div style="margin-bottom: 1rem;">
            <strong>ã‚¹ã‚³ã‚¢</strong>
            <select id="scoreFilter" style="width: 100%; margin-top: 0.5rem;">
                <option value="">ã™ã¹ã¦</option>
                <option value="10">10ä»¥ä¸Š</option>
                <option value="50">50ä»¥ä¸Š</option>
                <option value="100">100ä»¥ä¸Š</option>
            </select>
        </div>
        <button class="btn" style="width: 100%;" onclick="applyFilters()">é©ç”¨</button>
        <button class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem;" onclick="clearFilters()">ã‚¯ãƒªã‚¢</button>
        <hr style="margin: 1rem 0;">
        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.9rem;">
            <div>å–å¾—æ¸ˆã¿è³ªå•: <strong id="totalQuestions">-</strong></div>
            <div>è§£æ±ºæ¸ˆã¿: <strong id="answeredQuestions">-</strong></div>
            <div>æœªå›ç­”: <strong id="unansweredQuestions">-</strong></div>
        </div>
    </aside>

    <section>
        <div class="card" style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">è³ªå•ä¸€è¦§ <span id="resultCount" style="color: #666; font-size: 0.9rem;"></span></h3>
                <select id="sortBy" onchange="sortResults()">
                    <option value="score">ã‚¹ã‚³ã‚¢é †</option>
                    <option value="date">æ–°ã—ã„é †</option>
                    <option value="views">é–²è¦§æ•°é †</option>
                </select>
            </div>
        </div>

        <div id="questionList">
            <div class="spinner"></div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const state = {
        questions: [],
        filtered: [],
        answersCache: {}
    };

    function mapStatus(item) {
        if (item.has_accepted_answer) return 'accepted';
        if (item.is_answered) return 'answered';
        return 'unanswered';
    }

    function renderQuestions(list) {
        const container = document.getElementById('questionList');
        container.innerHTML = '';

        if (!list.length) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><h3>è©²å½“ã™ã‚‹è³ªå•ãŒã‚ã‚Šã¾ã›ã‚“</h3></div>';
            return;
        }

        list.forEach(item => {
            const status = mapStatus(item);
            const statusColor = status === 'accepted' ? '#4CAF50' : (status === 'answered' ? '#2196F3' : '#999');
            const tags = (item.tags || []).map(tag => `<span class="badge" style="background:#f5f5f5; color:#555; margin-right:4px;">${tag}</span>`).join(' ');
            const answersContainerId = `answers-${item.question_id}`;

            container.insertAdjacentHTML('beforeend', `
                <div class="card" style="border-left: 4px solid ${statusColor};">
                    <div style="display: flex; gap: 1rem;">
                        <div style="min-width: 70px; text-align: center; font-size: 0.85rem; color:#666;">
                            <div><strong style="font-size: 1.4rem; color:${statusColor};">${item.score ?? 0}</strong><br>æŠ•ç¥¨</div>
                            <div style="margin-top: 0.5rem;"><strong style="font-size: 1.1rem;">${item.answer_count ?? 0}</strong><br>å›ç­”</div>
                            <div style="margin-top: 0.5rem;"><strong>${item.view_count ?? 0}</strong><br>é–²è¦§</div>
                        </div>
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 0.5rem;">
                                <a href="${item.link}" target="_blank" rel="noopener noreferrer" style="color: var(--color-primary); text-decoration: none;">
                                    ${item.title}
                                </a>
                            </h3>
                            <p style="color: #666; margin-bottom: 0.75rem; line-height: 1.6;">
                                ${item.excerpt || ''}
                            </p>
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                <div>${tags}</div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-secondary" onclick="importQuestion('${item.question_id}')">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                                    <button class="btn" onclick="toggleAnswers('${item.question_id}')">ğŸ’¬ å›ç­”ã‚’è¡¨ç¤º</button>
                                    <a class="btn" href="${item.link}" target="_blank" rel="noopener noreferrer">è©³ç´°</a>
                                </div>
                            </div>
                            <div id="${answersContainerId}" style="margin-top: 1rem; display: none;"></div>
                        </div>
                    </div>
                </div>
            `);
        });
    }

    function updateStats(list) {
        const total = list.length;
        const answered = list.filter(item => mapStatus(item) !== 'unanswered').length;
        const unanswered = total - answered;
        document.getElementById('totalQuestions').textContent = total;
        document.getElementById('answeredQuestions').textContent = answered;
        document.getElementById('unansweredQuestions').textContent = unanswered;
        document.getElementById('resultCount').textContent = `(${total}ä»¶)`;
    }

    function applyFilters() {
        const statusFilters = Array.from(document.querySelectorAll('input[name="status"]:checked')).map(cb => cb.value);
        const scoreThreshold = parseInt(document.getElementById('scoreFilter').value || '0', 10);
        const query = document.getElementById('searchInput').value.toLowerCase();

        state.filtered = state.questions.filter(item => {
            const status = mapStatus(item);
            if (statusFilters.length && !statusFilters.includes(status)) return false;
            if ((item.score ?? 0) < scoreThreshold) return false;
            if (query) {
                const haystack = `${item.title} ${item.excerpt} ${(item.tags || []).join(' ')}`.toLowerCase();
                if (!haystack.includes(query)) return false;
            }
            return true;
        });

        renderQuestions(state.filtered);
        updateStats(state.filtered);
    }

    function clearFilters() {
        document.querySelectorAll('input[name="status"]').forEach(cb => cb.checked = true);
        document.getElementById('scoreFilter').value = '';
        document.getElementById('searchInput').value = '';
        state.filtered = [...state.questions];
        renderQuestions(state.filtered);
        updateStats(state.filtered);
    }

    function sortResults() {
        const sortBy = document.getElementById('sortBy').value;
        const list = state.filtered.length ? state.filtered : state.questions;
        const sorted = [...list];
        if (sortBy === 'score') {
            sorted.sort((a, b) => (b.score ?? 0) - (a.score ?? 0));
        } else if (sortBy === 'views') {
            sorted.sort((a, b) => (b.view_count ?? 0) - (a.view_count ?? 0));
        } else {
            sorted.sort((a, b) => (b.creation_date ?? 0) - (a.creation_date ?? 0));
        }
        state.filtered = sorted;
        renderQuestions(sorted);
    }

    function performSearch(event) {
        if (event) event.preventDefault();
        applyFilters();
    }

    function importQuestion(questionId) {
        alert(`è³ªå• ${questionId} ã‚’ãƒŠãƒ¬ãƒƒã‚¸åŒ–ã™ã‚‹å‡¦ç†ã¯æœªå®Ÿè£…ã§ã™ã€‚`);
    }

    async function toggleAnswers(questionId) {
        const container = document.getElementById(`answers-${questionId}`);
        if (!container) return;
        if (container.dataset.loaded === 'true') {
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
            return;
        }

        container.style.display = 'block';
        container.innerHTML = '<div class="spinner"></div>';
        try {
            const response = await fetch(`/api/serverfault/answers?question_id=${questionId}&translate=true`);
            const data = await response.json();
            if (!data.success) throw new Error(data.error || 'fetch failed');
            const answers = data.items || [];
            state.answersCache[questionId] = answers;
            container.innerHTML = renderAnswers(answers);
            container.dataset.loaded = 'true';
        } catch (err) {
            container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><h3>å›ç­”ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</h3><p>${err}</p></div>`;
        }
    }

    function renderAnswers(answers) {
        if (!answers.length) {
            return '<div class="empty-state"><div class="empty-state-icon">ğŸ’¬</div><h3>å›ç­”ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</h3></div>';
        }

        return answers.map(answer => `
            <div class="card" style="background:#f8f9fb; margin-bottom: 0.75rem; border-left: 4px solid ${answer.is_accepted ? '#4CAF50' : '#ccc'};">
                <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:0.5rem;">
                    <strong>${answer.is_accepted ? 'âœ… æ‰¿èªæ¸ˆã¿å›ç­”' : 'å›ç­”'}</strong>
                    <span style="color:#666;">ã‚¹ã‚³ã‚¢: ${answer.score ?? 0}</span>
                </div>
                <p style="color:#555; line-height:1.7;">${answer.body || answer.excerpt || ''}</p>
            </div>
        `).join('');
    }

    async function loadQuestions() {
        const container = document.getElementById('questionList');
        container.innerHTML = '<div class="spinner"></div>';
        try {
            const response = await fetch('/api/serverfault/questions?pagesize=20&translate=true');
            const data = await response.json();
            if (!data.success) throw new Error(data.error || 'fetch failed');
            state.questions = data.items || [];
            state.filtered = [...state.questions];
            renderQuestions(state.filtered);
            updateStats(state.filtered);
        } catch (err) {
            container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><h3>å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</h3><p>${err}</p></div>`;
        }
    }

    document.addEventListener('DOMContentLoaded', loadQuestions);
</script>
{% endblock %}
