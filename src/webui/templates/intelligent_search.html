{% extends "base.html" %}

{% block title %}AIæ¤œç´¢ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ - Mirai IT Knowledge Systems{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <div class="breadcrumb-content">
        <a href="/">ãƒ›ãƒ¼ãƒ </a>
        <span class="breadcrumb-separator">â€º</span>
        <span>AIæ¤œç´¢ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</span>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .search-hero {
        text-align: center;
        padding: 3rem 2rem;
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .search-hero h2 {
        color: var(--color-primary);
        margin-bottom: 1rem;
    }

    .search-input-large {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
    }

    .search-input-large input {
        width: 100%;
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        border: 2px solid #ddd;
        border-radius: 8px;
        transition: all 0.3s;
    }

    .search-input-large input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .search-examples {
        margin-top: 1rem;
        font-size: 0.9rem;
        color: #666;
    }

    .search-example {
        display: inline-block;
        margin: 0.25rem;
        padding: 0.25rem 0.75rem;
        background: white;
        border: 1px solid #ddd;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .search-example:hover {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
    }

    .search-results {
        display: none;
    }

    .search-results.show {
        display: block;
    }

    .intent-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        background: #e3f2fd;
        color: #1976d2;
        margin-right: 0.5rem;
    }

    .answer-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-left: 4px solid var(--color-primary);
    }

    .related-knowledge-item {
        padding: 1rem;
        border: 1px solid #eee;
        border-radius: 4px;
        margin-bottom: 0.75rem;
        transition: all 0.3s;
        cursor: pointer;
    }

    .related-knowledge-item:hover {
        background: #f8f9fa;
        border-color: var(--color-primary);
        transform: translateX(4px);
    }

    .suggestions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }

    .suggestion-chip {
        padding: 0.5rem 1rem;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 16px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s;
    }

    .suggestion-chip:hover {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
    }

    .ai-processing { overflow-x: auto; }
    .ai-pipeline { flex-wrap: nowrap; align-items: stretch; }
    .pipeline-stage { min-width: 170px; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 0.25rem; }
    .pipeline-arrow { white-space: nowrap; }
    .pulse-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin: 0.35rem auto 0;
        background: #c9c9c9;
        opacity: 0.35;
    }
    .pipeline-stage.active .pulse-dot,
    .pipeline-stage.processing .pulse-dot {
        background: var(--color-primary);
        opacity: 1;
        animation: pulseDot 1s ease-in-out infinite;
    }
    .pipeline-stage.completed .pulse-dot {
        background: #4caf50;
        opacity: 1;
    }
    @keyframes pulseDot {
        0% { transform: scale(0.8); opacity: 0.4; }
        50% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(0.8); opacity: 0.4; }
    }
</style>
{% endblock %}

{% block content %}
<div class="search-hero">
    <h2>ğŸ” AIæ¤œç´¢ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h2>
    <p style="color: #666; margin-bottom: 2rem;">è‡ªç„¶ãªè¨€è‘‰ã§è³ªå•ã—ã¦ãã ã•ã„ã€‚AIãŒæœ€é©ãªãƒŠãƒ¬ãƒƒã‚¸ã¨å›ç­”ã‚’æä¾›ã—ã¾ã™ã€‚</p>

    <div class="search-input-large">
        <form onsubmit="performSearch(event)">
            <input type="text" id="searchQuery" placeholder="ä¾‹: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒé…ã„æ™‚ã¯ã©ã†ã™ã‚Œã°ã„ã„ï¼Ÿ" autofocus>
        </form>
    </div>

    <div class="search-examples">
        ã‚ˆãä½¿ã†è³ªå•:
        <span class="search-example" onclick="fillExample('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒé…ã„æ™‚ã¯ã©ã†ã™ã‚Œã°ã„ã„ï¼Ÿ')">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒé…ã„æ™‚ã¯ï¼Ÿ</span>
        <span class="search-example" onclick="fillExample('Webã‚µãƒ¼ãƒãƒ¼ã®503ã‚¨ãƒ©ãƒ¼ã®åŸå› ã¯ï¼Ÿ')">503ã‚¨ãƒ©ãƒ¼ã®åŸå› ã¯ï¼Ÿ</span>
        <span class="search-example" onclick="fillExample('è¨¼æ˜æ›¸ã®æ›´æ–°æ‰‹é †ã¯ï¼Ÿ')">è¨¼æ˜æ›¸æ›´æ–°æ‰‹é †</span>
        <span class="search-example" onclick="fillExample('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è¨­å®šæ–¹æ³•ã¯ï¼Ÿ')">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š</span>
    </div>
</div>

<div id="searchResults" class="search-results">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="color: var(--color-primary);">æ¤œç´¢çµæœ</h3>
            <div>
                <span class="intent-badge" id="intentBadge"></span>
                <span style="color: #666; font-size: 0.9rem;" id="resultCount"></span>
            </div>
        </div>

        <div id="answerContent"></div>
    </div>

    <div id="relatedKnowledge"></div>

    <div id="suggestionsDiv" class="card" style="display: none;">
        <h4 style="color: #666; margin-bottom: 1rem;">ğŸ’¡ é–¢é€£ã™ã‚‹è³ªå•</h4>
        <div class="suggestions" id="suggestions"></div>
    </div>
</div>

<div id="loadingSpinner" class="card" style="display: none; text-align: center;">
    <div class="spinner"></div>
    <p style="color: #666;">AI ãŒæœ€é©ãªå›ç­”ã‚’æ¤œç´¢ä¸­...</p>
</div>

<div class="ai-processing" id="aiSearchProcessing" style="display: none;">
    <div class="ai-processing-header">
        <span class="processing-icon">âš¡</span>
        <span>AIå‡¦ç†ä¸­...</span>
    </div>
    <div class="ai-pipeline">
        <div class="pipeline-stage" id="searchStage1">
            <div class="stage-icon">ğŸ§ </div>
            <div class="pulse-dot"></div>
            <div class="stage-info">
                <span class="stage-name">Claude</span>
                <span class="stage-desc">åˆæœŸå›ç­”ç”Ÿæˆ</span>
            </div>
            <div class="pipeline-indicator waiting"></div>
        </div>
        <div class="pipeline-arrow">â†’</div>
        <div class="pipeline-stage" id="searchStage2">
            <div class="stage-icon">ğŸ”®</div>
            <div class="pulse-dot"></div>
            <div class="stage-info">
                <span class="stage-name">Gemini</span>
                <span class="stage-desc">æ¤œè¨¼ãƒ»è£œå®Œ</span>
            </div>
            <div class="pipeline-indicator waiting"></div>
        </div>
        <div class="pipeline-arrow">â†’</div>
        <div class="pipeline-stage" id="searchStage3">
            <div class="stage-icon">ğŸŒ</div>
            <div class="pulse-dot"></div>
            <div class="stage-info">
                <span class="stage-name">Perplexity</span>
                <span class="stage-desc">æœ€æ–°æƒ…å ±ç¢ºèª</span>
            </div>
            <div class="pipeline-indicator waiting"></div>
        </div>
    </div>
    <div class="processing-message" id="searchProcessingMessage">
        <p>æº–å‚™ä¸­...</p>
    </div>
</div>

<script>
function fillExample(text) {
    document.getElementById('searchQuery').value = text;
    document.getElementById('searchQuery').focus();
    performSearch();
}

async function performSearch(event) {
    if (event) event.preventDefault();

    const query = document.getElementById('searchQuery').value.trim();
    if (!query) return;

    // UIæ›´æ–°
    document.getElementById('searchResults').classList.remove('show');
    document.getElementById('loadingSpinner').style.display = 'block';
    showProcessing('å›ç­”ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...');
    const processingStart = Date.now();
    await new Promise(requestAnimationFrame);

    try {
        const response = await fetch('/api/search/intelligent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query })
        });

        const data = await response.json();

        // çµæœã‚’è¡¨ç¤º
        displayResults(data);

    } catch (error) {
        showToast('æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    } finally {
        document.getElementById('loadingSpinner').style.display = 'none';
        const elapsed = Date.now() - processingStart;
        const minShowMs = 1500;
        if (elapsed < minShowMs) {
            setTimeout(() => hideProcessing(), minShowMs - elapsed);
        } else {
            hideProcessing();
        }
    }
}

function displayResults(data) {
    // Intentè¡¨ç¤º
    const intentTexts = {
        'how_to': 'â“ æ–¹æ³•ã‚’çŸ¥ã‚ŠãŸã„',
        'why': 'ğŸ¤” ç†ç”±ãƒ»åŸå› ã‚’çŸ¥ã‚ŠãŸã„',
        'what': 'ğŸ“– å®šç¾©ãƒ»èª¬æ˜ã‚’çŸ¥ã‚ŠãŸã„',
        'when': 'ğŸ“… æ™‚æœŸãƒ»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’çŸ¥ã‚ŠãŸã„',
        'general': 'ğŸ’¬ ä¸€èˆ¬çš„ãªè³ªå•'
    };
    document.getElementById('intentBadge').textContent = intentTexts[data.intent.type] || data.intent.type;

    // çµæœæ•°
    const knowledgeCount = data.knowledge.length;
    document.getElementById('resultCount').textContent = `${knowledgeCount}ä»¶ã®ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;

    // å›ç­”å†…å®¹
    const answerDiv = document.getElementById('answerContent');
    if (data.answer.text) {
        answerDiv.innerHTML = `
            <div class="answer-section">
                <h4 style="color: var(--color-primary); margin-bottom: 1rem;">ğŸ¤– AI ã®å›ç­”</h4>
                <div style="line-height: 1.8;">${formatMarkdown(data.answer.text)}</div>
            </div>
        `;
    }

    // é–¢é€£ãƒŠãƒ¬ãƒƒã‚¸
    const relatedDiv = document.getElementById('relatedKnowledge');
    if (data.knowledge.length > 0) {
        let html = '<div class="card"><h4 style="color: #666; margin-bottom: 1rem;">ğŸ“š é–¢é€£ãƒŠãƒ¬ãƒƒã‚¸</h4>';

        data.knowledge.forEach(k => {
            const badgeClass = 'badge-' + k.itsm_type.lower();
            html += `
                <div class="related-knowledge-item" onclick="window.location.href='/knowledge/${k.id}'">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <strong style="color: var(--color-primary);">${k.title}</strong>
                        <span class="badge ${badgeClass}">${k.itsm_type}</span>
                    </div>
                    ${k.summary_non_technical ? '<p style="color: #666; font-size: 0.9rem; margin: 0;">' + k.summary_non_technical.substring(0, 100) + '...</p>' : ''}
                </div>
            `;
        });

        html += '</div>';
        relatedDiv.innerHTML = html;
    } else {
        relatedDiv.innerHTML = '';
    }

    // é–¢é€£è³ªå•ã®ææ¡ˆ
    if (data.suggestions && data.suggestions.length > 0) {
        document.getElementById('suggestionsDiv').style.display = 'block';
        const suggestionsDiv = document.getElementById('suggestions');
        suggestionsDiv.innerHTML = '';

        data.suggestions.forEach(sug => {
            const chip = document.createElement('div');
            chip.className = 'suggestion-chip';
            chip.textContent = sug;
            chip.onclick = () => {
                document.getElementById('searchQuery').value = sug;
                performSearch();
            };
            suggestionsDiv.appendChild(chip);
        });
    } else {
        document.getElementById('suggestionsDiv').style.display = 'none';
    }

    // çµæœè¡¨ç¤º
    document.getElementById('searchResults').classList.add('show');

    // æ¤œç´¢å±¥æ­´ã«è¨˜éŒ²ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    if (data.knowledge.length > 0) {
        showToast(`${data.knowledge.length}ä»¶ã®ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`, 'success');
    } else if (data.answer.has_enrichments) {
        showToast('å¤–éƒ¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ', 'info');
    } else {
        showToast('è©²å½“ã™ã‚‹ãƒŠãƒ¬ãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'info');
    }
}

function formatMarkdown(text) {
    // ç°¡æ˜“çš„ãªMarkdownãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    return text
        .replace(/### (.+)/g, '<h4 style="color: #555; margin: 1rem 0 0.5rem 0;">$1</h4>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" style="color: var(--color-primary);">$1</a>')
        .replace(/- (.+)/g, '<li>$1</li>')
        .replace(/\n/g, '<br>');
}

function resetStages() {
    ['searchStage1', 'searchStage2', 'searchStage3'].forEach(id => {
        const stage = document.getElementById(id);
        if (!stage) return;
        stage.classList.remove('active', 'completed');
        const indicator = stage.querySelector('.pipeline-indicator');
        if (indicator) indicator.className = 'pipeline-indicator waiting';
    });
}

function updateStage(step, status) {
    const stage = document.getElementById(`searchStage${step}`);
    if (!stage) return;
    stage.classList.remove('active', 'completed');
    if (status === 'active') stage.classList.add('active');
    if (status === 'completed') stage.classList.add('completed');
    const indicator = stage.querySelector('.pipeline-indicator');
    if (indicator) indicator.className = `pipeline-indicator ${status}`;
}

function showProcessing(message) {
    const processing = document.getElementById('aiSearchProcessing');
    const messageEl = document.getElementById('searchProcessingMessage');
    if (messageEl) messageEl.innerHTML = `<p>${message || 'å‡¦ç†ä¸­...'}</p>`;
    resetStages();
    updateStage(1, 'active');
    if (window.__searchStageTimers) {
        window.__searchStageTimers.forEach(t => clearTimeout(t));
    }
    window.__searchStageTimers = [
        setTimeout(() => updateStage(1, 'completed'), 400),
        setTimeout(() => updateStage(2, 'active'), 450),
        setTimeout(() => updateStage(2, 'completed'), 1100),
        setTimeout(() => updateStage(3, 'active'), 1150),
        setTimeout(() => updateStage(3, 'completed'), 1900),
    ];
    processing.style.display = 'block';
}

function hideProcessing() {
    const processing = document.getElementById('aiSearchProcessing');
    if (window.__searchStageTimers) {
        window.__searchStageTimers.forEach(t => clearTimeout(t));
        window.__searchStageTimers = null;
    }
    resetStages();
    processing.style.display = 'none';
}
</script>
{% endblock %}
