{% extends "base.html" %}

{% block title %}AIå¯¾è©±ãƒŠãƒ¬ãƒƒã‚¸ä½œæˆ - Mirai IT Knowledge Systems{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <div class="breadcrumb-content">
        <a href="/">ãƒ›ãƒ¼ãƒ </a>
        <span class="breadcrumb-separator">â€º</span>
        <span>AIå¯¾è©±ãƒŠãƒ¬ãƒƒã‚¸ä½œæˆ</span>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 1.5rem;
        height: calc(100vh - 400px);
    }

    .chat-main {
        display: flex;
        flex-direction: column;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .message {
        margin-bottom: 1.5rem;
        padding: 1rem;
        border-radius: 8px;
        animation: fadeIn 0.3s;
    }

    .message.user {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        border-left: 3px solid var(--color-primary);
        margin-left: 2rem;
    }

    .message.assistant {
        background: #f8f9fa;
        border-left: 3px solid #4CAF50;
        margin-right: 2rem;
    }

    .message-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: #666;
    }

    .message-content {
        color: #333;
        line-height: 1.8;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .chat-input-area {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chat-input {
        display: flex;
        gap: 0.5rem;
    }

    .chat-input textarea {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: none;
        font-family: inherit;
    }

    .chat-input button {
        padding: 0.75rem 1.5rem;
        background: var(--color-primary);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
    }

    .chat-input button:hover:not(:disabled) {
        background: var(--color-primary-dark);
        transform: translateY(-1px);
    }

    .chat-input button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .chat-sidebar {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow-y: auto;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--color-primary), #4CAF50);
        transition: width 0.5s ease;
        border-radius: 4px;
    }

    .collected-info {
        font-size: 0.9rem;
    }

    .collected-info-item {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }

    .collected-info-item.collected {
        background: #e8f5e9;
        border-left: 3px solid #4CAF50;
    }

    .collected-info-item.missing {
        background: #fff3e0;
        border-left: 3px solid #ff9800;
    }

    .quick-actions {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #eee;
    }

    .quick-action-btn {
        display: block;
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        text-align: left;
        transition: all 0.3s;
    }

    .quick-action-btn:hover {
        background: #ebebeb;
        border-color: var(--color-primary);
    }

    @media (max-width: 968px) {
        .chat-container {
            grid-template-columns: 1fr;
        }

        .chat-sidebar {
            order: -1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-left: 4px solid var(--color-primary);">
    <h2>ğŸ’¬ AIå¯¾è©±ã§ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä½œæˆ</h2>
    <p style="color: #666;">
        AIã¨ã®å¯¾è©±ã‚’é€šã˜ã¦ã€æ§‹é€ åŒ–ã•ã‚ŒãŸé«˜å“è³ªãªãƒŠãƒ¬ãƒƒã‚¸ã‚’ç°¡å˜ã«ä½œæˆã§ãã¾ã™ã€‚
        è³ªå•ã«ç­”ãˆã‚‹ã ã‘ã§ã€è‡ªå‹•çš„ã«å¿…è¦ãªæƒ…å ±ãŒæ•´ç†ã•ã‚Œã¾ã™ã€‚
    </p>
</div>

<div class="chat-container">
    <div class="chat-main">
        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                <div class="message-header">
                    <strong>ğŸ¤– AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</strong>
                    <span id="timestamp">{{ now }}</span>
                </div>
                <div class="message-content">
                    ã“ã‚“ã«ã¡ã¯ï¼ãƒŠãƒ¬ãƒƒã‚¸ä½œæˆã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚<br>
                    ã¾ãšã€ã©ã‚“ãªäº‹è±¡ã«ã¤ã„ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿç°¡å˜ã«æ•™ãˆã¦ãã ã•ã„ã€‚<br>
                    <small style="color: #999;">ï¼ˆä¾‹: ã€Œæ˜¨æ—¥Webã‚µãƒ¼ãƒãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã€ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒé…ããªã£ãŸã€ï¼‰</small>
                </div>
            </div>
        </div>

        <div class="chat-input-area">
            <div class="chat-input">
                <textarea id="userInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›... (Enter ã§é€ä¿¡ã€Shift+Enter ã§æ”¹è¡Œ)" rows="2"></textarea>
                <button id="sendBtn" onclick="sendMessage()">é€ä¿¡</button>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #999;">
                ğŸ’¡ ãƒ’ãƒ³ãƒˆ: åˆ†ã‹ã‚‹ç¯„å›²ã§ç­”ãˆã¦ãã ã•ã„ã€‚AIãŒè‡ªå‹•çš„ã«æ•´ç†ã—ã¾ã™ã€‚
            </div>
        </div>
    </div>

    <div class="chat-sidebar">
        <h3 style="color: var(--color-primary); margin-bottom: 1rem;">ğŸ“Š åé›†çŠ¶æ³</h3>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <div style="text-align: center; margin-bottom: 1rem; font-size: 0.9rem; color: #666;">
            <span id="progressText">0%</span> å®Œäº†
        </div>

        <div class="collected-info" id="collectedInfo">
            <div class="collected-info-item missing">
                ğŸ“… ç™ºç”Ÿæ—¥æ™‚
            </div>
            <div class="collected-info-item missing">
                ğŸ–¥ï¸ å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ 
            </div>
            <div class="collected-info-item missing">
                âš ï¸ ç—‡çŠ¶ãƒ»ã‚¨ãƒ©ãƒ¼
            </div>
            <div class="collected-info-item missing">
                ğŸ‘¥ å½±éŸ¿ç¯„å›²
            </div>
            <div class="collected-info-item missing">
                ğŸ”§ å¯¾å¿œå†…å®¹
            </div>
            <div class="collected-info-item missing">
                ğŸ” åŸå› 
            </div>
            <div class="collected-info-item missing">
                ğŸ“ ä»Šå¾Œã®å¯¾ç­–
            </div>
        </div>

        <div class="quick-actions">
            <h4 style="color: #666; margin-bottom: 0.5rem; font-size: 0.9rem;">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h4>
            <button class="quick-action-btn" onclick="skipToGenerate()" id="skipBtn" disabled>
                â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç”Ÿæˆ
            </button>
            <button class="quick-action-btn" onclick="resetChat()">
                ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™
            </button>
            <button class="quick-action-btn" onclick="window.location.href='/knowledge/create'">
                ğŸ“ é€šå¸¸ä½œæˆã«åˆ‡ã‚Šæ›¿ãˆ
            </button>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
let sessionId = 'session_' + Date.now();
let conversationHistory = [];
let collectedData = {
    when: null,
    system: null,
    symptom: null,
    impact: null,
    response: null,
    cause: null,
    measures: null
};

const socket = io();

socket.on('connect', () => {
    socket.emit('join_chat', { session_id: sessionId });
});

socket.on('chat_response', (data) => {
    handleChatResponse(data);
});

socket.on('chat_generated', (data) => {
    setSendState(false);
    showGeneratedKnowledge(data);
});

socket.on('chat_error', (data) => {
    setSendState(false);
    addMessage('assistant', `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${data.error || 'unknown error'}`);
});

// Enterã‚­ãƒ¼ã§é€ä¿¡
document.getElementById('userInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

function setSendState(isSending) {
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = isSending;
    sendBtn.textContent = isSending ? 'å‡¦ç†ä¸­...' : 'é€ä¿¡';
}

function handleChatResponse(data) {
    setSendState(false);
    if (data.type === 'question') {
        addMessage('assistant', data.question);
        updateProgress(data.progress);
    } else if (data.type === 'knowledge_generated') {
        showGeneratedKnowledge(data);
    }
}

function sendMessage() {
    const input = document.getElementById('userInput');
    const message = input.value.trim();

    if (!message) return;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    addMessage('user', message);
    input.value = '';

    setSendState(true);

    socket.emit('chat_message', {
        session_id: sessionId,
        message: message,
        user_id: 'webui_user'
    });
}

function addMessage(role, content) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ' + role;

    const now = new Date().toLocaleTimeString('ja-JP');
    const roleText = role === 'user' ? 'ğŸ‘¤ ã‚ãªãŸ' : 'ğŸ¤– AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ';

    messageDiv.innerHTML = `
        <div class="message-header">
            <strong>${roleText}</strong>
            <span>${now}</span>
        </div>
        <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
    `;

    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    conversationHistory.push({ role, content, timestamp: now });
}

function updateProgress(progress) {
    const percentage = progress.percentage;
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    progressFill.style.width = percentage + '%';
    progressText.textContent = percentage + '%';

    // åé›†çŠ¶æ³ã‚’æ›´æ–°
    const items = ['when', 'system', 'symptom', 'impact', 'response', 'cause', 'measures'];
    const labels = ['ğŸ“… ç™ºç”Ÿæ—¥æ™‚', 'ğŸ–¥ï¸ å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ', 'âš ï¸ ç—‡çŠ¶ãƒ»ã‚¨ãƒ©ãƒ¼', 'ğŸ‘¥ å½±éŸ¿ç¯„å›²', 'ğŸ”§ å¯¾å¿œå†…å®¹', 'ğŸ” åŸå› ', 'ğŸ“ ä»Šå¾Œã®å¯¾ç­–'];
    const infoDiv = document.getElementById('collectedInfo');

    infoDiv.innerHTML = '';
    items.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'collected-info-item ' + (progress.collected[item] ? 'collected' : 'missing');
        div.innerHTML = labels[index] + (progress.collected[item] ? ' âœ“' : '');
        infoDiv.appendChild(div);
    });

    // ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
    if (percentage >= 50) {
        document.getElementById('skipBtn').disabled = false;
    }
}

function showGeneratedKnowledge(data) {
    // ç”Ÿæˆå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    let message = `
        âœ… ãƒŠãƒ¬ãƒƒã‚¸ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼<br><br>
        <strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${data.title}<br>
        <strong>ITSMã‚¿ã‚¤ãƒ—:</strong> ${data.itsm_type} (ä¿¡é ¼åº¦: ${Math.round(data.confidence * 100)}%)<br><br>
        <strong>å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong><br>
        <div style="background: #f5f5f5; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; max-height: 200px; overflow-y: auto; white-space: pre-wrap;">${data.content.substring(0, 500)}...</div>
    `;

    if (data.similar_knowledge && data.similar_knowledge.length > 0) {
        message += `<br><br>âš ï¸ é¡ä¼¼ã™ã‚‹ãƒŠãƒ¬ãƒƒã‚¸ãŒ ${data.similar_knowledge.length} ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚`;
    }

    message += `<br><br>
        <button onclick="saveKnowledge('${data.title.replace(/'/g, "\\'")}', '${data.itsm_type}')" class="btn">ä¿å­˜ã™ã‚‹</button>
        <button onclick="editKnowledge()" class="btn btn-secondary" style="margin-left: 0.5rem;">ç·¨é›†ã™ã‚‹</button>
    `;

    addMessage('assistant', message);

    // ç”Ÿæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    window.generatedKnowledge = data;
}

async function saveKnowledge(title, itsmType) {
    const data = window.generatedKnowledge;

    try {
        const response = await fetch('/api/chat/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: data.title,
                content: data.content,
                itsm_type: data.itsm_type,
                session_id: sessionId,
                conversation_history: conversationHistory
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast('ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            setTimeout(() => {
                window.location.href = '/knowledge/' + result.knowledge_id + '?success=1&message=AIå¯¾è©±ã§ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä½œæˆã—ã¾ã—ãŸ';
            }, 1000);
        } else {
            showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    } catch (error) {
        showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }
}

function editKnowledge() {
    const data = window.generatedKnowledge;
    // é€šå¸¸ä½œæˆãƒšãƒ¼ã‚¸ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦é·ç§»
    const params = new URLSearchParams({
        title: data.title,
        content: data.content,
        itsm_type: data.itsm_type
    });
    window.location.href = '/knowledge/create?' + params.toString();
}

function skipToGenerate() {
    addMessage('user', 'ç¾åœ¨ã®æƒ…å ±ã§ç”Ÿæˆã—ã¦ãã ã•ã„');
    sendMessage();
}

function resetChat() {
    if (confirm('ä¼šè©±ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        sessionId = 'session_' + Date.now();
        conversationHistory = [];
        socket.emit('join_chat', { session_id: sessionId });
        collectedData = {
            when: null,
            system: null,
            symptom: null,
            impact: null,
            response: null,
            cause: null,
            measures: null
        };

        document.getElementById('chatMessages').innerHTML = `
            <div class="message assistant">
                <div class="message-header">
                    <strong>ğŸ¤– AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</strong>
                    <span>${new Date().toLocaleTimeString('ja-JP')}</span>
                </div>
                <div class="message-content">
                    ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚æœ€åˆã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼<br>
                    ã©ã‚“ãªäº‹è±¡ã«ã¤ã„ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ
                </div>
            </div>
        `;

        updateProgress({ percentage: 0, collected: collectedData });
        document.getElementById('skipBtn').disabled = true;
    }
}

// åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
window.addEventListener('load', function() {
    setTimeout(() => {
        const hint = document.getElementById('keyboard-hint');
        if (hint) {
            hint.innerHTML = 'AIå¯¾è©±ãƒ¢ãƒ¼ãƒ‰: è³ªå•ã«ç­”ãˆã¦ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä½œæˆ';
            hint.classList.add('show');
            setTimeout(() => hint.classList.remove('show'), 5000);
        }
    }, 500);
});
</script>
{% endblock %}
