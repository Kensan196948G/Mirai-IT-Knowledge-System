{% extends "base.html" %}

{% block title %}AIå¯¾è©±ãƒŠãƒ¬ãƒƒã‚¸ä½œæˆ - Mirai IT Knowledge Systems{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <div class="breadcrumb-content">
        <a href="/">ãƒ›ãƒ¼ãƒ </a>
        <span class="breadcrumb-separator">â€º</span>
        <span>AIå¯¾è©±ãƒŠãƒ¬ãƒƒã‚¸ä½œæˆ</span>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠå…¨ä½“ï¼ˆ1ã¤ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸï¼‰ */
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 300px);
        min-height: 400px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    /* çµ±åˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰ */
    .chat-content-wrapper {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        padding: 1.5rem;
        scrollbar-width: thick;
        scrollbar-color: #1976d2 #e0e0e0;
    }

    .chat-content-wrapper::-webkit-scrollbar {
        width: 14px;
    }

    .chat-content-wrapper::-webkit-scrollbar-track {
        background: #e0e0e0;
        border-radius: 7px;
    }

    .chat-content-wrapper::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #4CAF50, #2196F3, #9c27b0);
        border-radius: 7px;
        border: 2px solid #e0e0e0;
    }

    .chat-content-wrapper::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #388E3C, #1976D2, #7b1fa2);
    }

    /* ãƒ¡ã‚¤ãƒ³ã¨ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æ¨ªä¸¦ã³ */
    .chat-inner {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 1.5rem;
        min-height: 100%;
    }

    /* ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
    .chat-main {
        display: flex;
        flex-direction: column;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    .chat-messages {
        flex: 1;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    .chat-messages::-webkit-scrollbar {
        width: 12px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: #e0e0e0;
        border-radius: 6px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #4CAF50, #2196F3);
        border-radius: 6px;
        border: 2px solid #e0e0e0;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #388E3C, #1976D2);
    }

    .message {
        margin-bottom: 1.5rem;
        padding: 1rem;
        border-radius: 8px;
        animation: fadeIn 0.3s;
    }

    .message.user {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        border-left: 3px solid var(--color-primary);
        margin-left: 2rem;
    }

    .message.assistant {
        background: #f8f9fa;
        border-left: 3px solid #4CAF50;
        margin-right: 2rem;
    }

    .message-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: #666;
    }

    .message-content {
        color: #333;
        line-height: 1.8;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .chat-input-area {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chat-input {
        display: flex;
        gap: 0.5rem;
    }

    .chat-input textarea {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: none;
        font-family: inherit;
    }

    .chat-input button {
        padding: 0.75rem 1.5rem;
        background: var(--color-primary);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
    }

    .chat-input button:hover:not(:disabled) {
        background: var(--color-primary-dark);
        transform: translateY(-1px);
    }

    .chat-input button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆåé›†çŠ¶æ³ï¼‰ */
    .chat-sidebar {
        background: linear-gradient(135deg, #f3e5f5 0%, #e8eaf6 100%);
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid #e0e0e0;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--color-primary), #4CAF50);
        transition: width 0.5s ease;
        border-radius: 4px;
    }

    .collected-info {
        font-size: 0.9rem;
    }

    .collected-info-item {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }

    .collected-info-item.collected {
        background: #e8f5e9;
        border-left: 3px solid #4CAF50;
    }

    .collected-info-item.missing {
        background: #fff3e0;
        border-left: 3px solid #ff9800;
    }

    .quick-actions {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #eee;
    }

    .quick-action-btn {
        display: block;
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        text-align: left;
        transition: all 0.3s;
    }

    .quick-action-btn:hover {
        background: #ebebeb;
        border-color: var(--color-primary);
    }

    @media (max-width: 968px) {
        .chat-container {
            grid-template-columns: 1fr;
        }

        .chat-sidebar {
            order: -1;
        }
    }

    /* AIå›ç­”ã‚¹ã‚¿ã‚¤ãƒ« */
    .ai-answer-wrapper {
        background: linear-gradient(135deg, #e8f5e9 0%, #e3f2fd 50%, #f3e5f5 100%);
        border: 2px solid #4CAF50;
        border-radius: 12px;
        padding: 1rem;
        margin: 1rem 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .ai-process-flow {
        background: rgba(255,255,255,0.8);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .process-label {
        font-weight: 600;
        color: #1976d2;
    }

    .process-steps {
        color: #333;
    }

    .ai-answer-box {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #e0e0e0;
    }

    .ai-answer-header {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1565c0;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e3f2fd;
    }

    .ai-answer-content {
        line-height: 1.8;
        color: #333;
    }

    .ai-answer-content .code-block {
        background: #263238;
        color: #aed581;
        padding: 1rem;
        border-radius: 6px;
        overflow-x: auto;
        margin: 0.5rem 0;
        font-family: 'Consolas', monospace;
        font-size: 0.9rem;
    }

    .ai-answer-content .inline-code {
        background: #f5f5f5;
        color: #c62828;
        padding: 0.1rem 0.4rem;
        border-radius: 4px;
        font-family: 'Consolas', monospace;
        font-size: 0.9em;
    }

    .ai-answer-content .list-number {
        color: #1976d2;
        font-weight: 600;
    }

    .ai-evidence-section {
        background: #fff8e1;
        border: 1px solid #ffcc02;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .evidence-header {
        font-weight: 600;
        color: #f57c00;
        margin-bottom: 0.75rem;
        font-size: 1rem;
    }

    .ai-evidence-item {
        display: flex;
        gap: 0.75rem;
        padding: 0.75rem;
        background: white;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        border-left: 3px solid #ffc107;
    }

    .evidence-number {
        background: #ff9800;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
        flex-shrink: 0;
    }

    .evidence-content {
        flex: 1;
    }

    .ai-evidence-source {
        font-weight: 500;
        color: #333;
        margin-bottom: 0.25rem;
    }

    .evidence-link {
        margin-left: 0.5rem;
        color: #1976d2;
        text-decoration: none;
        font-size: 0.85rem;
    }

    .evidence-link:hover {
        text-decoration: underline;
    }

    .evidence-snippet {
        font-size: 0.85rem;
        color: #666;
        line-height: 1.5;
    }

    .ai-sources-section {
        background: #e3f2fd;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        font-size: 0.85rem;
    }

    .sources-label {
        font-weight: 500;
        color: #1565c0;
    }

    .source-link {
        margin-left: 0.5rem;
        color: #1976d2;
        text-decoration: none;
        background: white;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
    }

    .source-link:hover {
        background: #bbdefb;
    }

    .ai-meta-bar {
        display: flex;
        gap: 1.5rem;
        padding: 0.75rem 1rem;
        background: rgba(255,255,255,0.8);
        border-radius: 6px;
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }

    .meta-item {
        color: #666;
    }

    .ai-answer-actions {
        display: flex;
        gap: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #c8e6c9;
    }

    .ai-answer-actions .btn {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        border-radius: 6px;
    }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’ç›®ç«‹ãŸã›ã‚‹ */
    .ai-answer-box::-webkit-scrollbar,
    .ai-answer-content::-webkit-scrollbar {
        width: 12px;
    }

    .ai-answer-box::-webkit-scrollbar-track,
    .ai-answer-content::-webkit-scrollbar-track {
        background: #e0e0e0;
        border-radius: 6px;
    }

    .ai-answer-box::-webkit-scrollbar-thumb,
    .ai-answer-content::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #1976d2, #7b1fa2);
        border-radius: 6px;
        border: 2px solid #e0e0e0;
    }

    .ai-answer-box::-webkit-scrollbar-thumb:hover,
    .ai-answer-content::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #1565c0, #6a1b9a);
    }

    /* Firefoxç”¨ */
    .ai-answer-box,
    .ai-answer-content {
        scrollbar-width: thick;
        scrollbar-color: #1976d2 #e0e0e0;
    }

    .ai-answer-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        color: #1565c0;
        font-weight: 600;
        position: sticky;
        top: 0;
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        padding-bottom: 0.5rem;
        z-index: 1;
    }

    .ai-answer-content {
        background: white;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 0.75rem;
        line-height: 1.8;
        max-height: 200px !important;
        overflow-y: auto !important;
        word-wrap: break-word;
    }

    .ai-evidence-section {
        background: #fff8e1;
        border-left: 3px solid #ffc107;
        padding: 0.75rem;
        margin-top: 0.5rem;
        border-radius: 0 4px 4px 0;
        font-size: 0.9rem;
    }

    .ai-evidence-item {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: white;
        border-radius: 4px;
    }

    .ai-evidence-source {
        font-weight: 500;
        color: #333;
    }

    .ai-evidence-url {
        font-size: 0.85rem;
        color: #1976d2;
        word-break: break-all;
    }

    .ai-meta {
        display: flex;
        gap: 1rem;
        margin-top: 0.75rem;
        font-size: 0.85rem;
        color: #666;
    }

    .ai-meta-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .confidence-high { color: #4caf50; }
    .confidence-medium { color: #ff9800; }
    .confidence-low { color: #f44336; }

    .ai-question-input {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e0e0e0;
    }

    .ai-question-input input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .ai-question-btn {
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
    }

    .ai-question-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .ai-question-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="card" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-left: 4px solid var(--color-primary);">
    <h2>ğŸ’¬ AIå¯¾è©±ã§ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä½œæˆ</h2>
    <p style="color: #666;">
        AIã¨ã®å¯¾è©±ã‚’é€šã˜ã¦ã€æ§‹é€ åŒ–ã•ã‚ŒãŸé«˜å“è³ªãªãƒŠãƒ¬ãƒƒã‚¸ã‚’ç°¡å˜ã«ä½œæˆã§ãã¾ã™ã€‚
        è³ªå•ã«ç­”ãˆã‚‹ã ã‘ã§ã€è‡ªå‹•çš„ã«å¿…è¦ãªæƒ…å ±ãŒæ•´ç†ã•ã‚Œã¾ã™ã€‚
    </p>
</div>

<div class="chat-container">
    <!-- çµ±åˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸ -->
    <div class="chat-content-wrapper">
        <div class="chat-inner">
            <!-- å·¦å´ï¼šAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ -->
            <div class="chat-main">
                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant">
                        <div class="message-header">
                            <strong>ğŸ¤– AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</strong>
                            <span id="timestamp">{{ now }}</span>
                        </div>
                        <div class="message-content">
                            ã“ã‚“ã«ã¡ã¯ï¼ãƒŠãƒ¬ãƒƒã‚¸ä½œæˆã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚<br>
                            ã¾ãšã€ã©ã‚“ãªäº‹è±¡ã«ã¤ã„ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿç°¡å˜ã«æ•™ãˆã¦ãã ã•ã„ã€‚<br>
                            <small style="color: #999;">ï¼ˆä¾‹: ã€Œæ˜¨æ—¥Webã‚µãƒ¼ãƒãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã€ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒé…ããªã£ãŸã€ï¼‰</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šåé›†çŠ¶æ³ -->
            <div class="chat-sidebar">
        <h3 style="color: var(--color-primary); margin-bottom: 1rem;">ğŸ“Š åé›†çŠ¶æ³</h3>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <div style="text-align: center; margin-bottom: 1rem; font-size: 0.9rem; color: #666;">
            <span id="progressText">0%</span> å®Œäº†
        </div>

        <div class="collected-info" id="collectedInfo">
            <div class="collected-info-item missing">
                ğŸ“… ç™ºç”Ÿæ—¥æ™‚
            </div>
            <div class="collected-info-item missing">
                ğŸ–¥ï¸ å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ 
            </div>
            <div class="collected-info-item missing">
                âš ï¸ ç—‡çŠ¶ãƒ»ã‚¨ãƒ©ãƒ¼
            </div>
            <div class="collected-info-item missing">
                ğŸ‘¥ å½±éŸ¿ç¯„å›²
            </div>
            <div class="collected-info-item missing">
                ğŸ”§ å¯¾å¿œå†…å®¹
            </div>
            <div class="collected-info-item missing">
                ğŸ” åŸå› 
            </div>
            <div class="collected-info-item missing">
                ğŸ“ ä»Šå¾Œã®å¯¾ç­–
            </div>
        </div>

        <div class="quick-actions">
            <h4 style="color: #666; margin-bottom: 0.5rem; font-size: 0.9rem;">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h4>
            <button class="quick-action-btn" onclick="skipToGenerate()" id="skipBtn" disabled>
                â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç”Ÿæˆ
            </button>
            <button class="quick-action-btn" onclick="resetChat()">
                ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™
            </button>
            <button class="quick-action-btn" onclick="window.location.href='/knowledge/create'">
                ğŸ“ é€šå¸¸ä½œæˆã«åˆ‡ã‚Šæ›¿ãˆ
            </button>
        </div>

                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid #e0e0e0;">
                    <h4 style="color: #1565c0; margin-bottom: 0.75rem; font-size: 0.9rem;">ğŸ¤– AIã«è³ªå•</h4>
                    <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">
                        ITã«é–¢ã™ã‚‹è³ªå•ã‚’AIãŒå›ç­”ã—ã¾ã™
                    </p>
                    <div class="ai-question-input">
                        <input type="text" id="aiQuestionInput" placeholder="è³ªå•ã‚’å…¥åŠ›..." onkeydown="if(event.key==='Enter')askAI()">
                        <button class="ai-question-btn" onclick="askAI()" id="askAiBtn">è³ªå•</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸå¤–ã«å›ºå®šï¼‰ -->
    <div class="chat-input-area">
        <div class="chat-input">
            <textarea id="userInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›... (Enter ã§é€ä¿¡ã€Shift+Enter ã§æ”¹è¡Œ)" rows="2"></textarea>
            <button id="sendBtn" onclick="sendMessage()">é€ä¿¡</button>
        </div>
        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #999;">
            ğŸ’¡ ãƒ’ãƒ³ãƒˆ: åˆ†ã‹ã‚‹ç¯„å›²ã§ç­”ãˆã¦ãã ã•ã„ã€‚AIãŒè‡ªå‹•çš„ã«æ•´ç†ã—ã¾ã™ã€‚
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.6.0/socket.io.min.js" crossorigin="anonymous"></script>
<script>
let sessionId = 'session_' + Date.now();
let conversationHistory = [];
let collectedData = {
    when: null,
    system: null,
    symptom: null,
    impact: null,
    response: null,
    cause: null,
    measures: null
};

// Socket.IOæ¥ç¶šï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ï¼‰
const socket = io({
    transports: ['polling'],
    upgrade: false
});

socket.on('connect', () => {
    socket.emit('join_chat', { session_id: sessionId });
});

socket.on('chat_response', (data) => {
    handleChatResponse(data);
});

socket.on('chat_generated', (data) => {
    setSendState(false);
    showGeneratedKnowledge(data);
});

socket.on('chat_error', (data) => {
    setSendState(false);
    addMessage('assistant', `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${data.error || 'unknown error'}`);
});

// AIå›ç­”ã‚¤ãƒ™ãƒ³ãƒˆ
socket.on('ai_answer', (data) => {
    setAiState(false);
    if (data.success) {
        displayAiAnswer(data);
    } else {
        addMessage('assistant', `AIå›ç­”ã‚¨ãƒ©ãƒ¼: ${data.error || 'å›ç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ'}`);
    }
});

socket.on('ai_error', (data) => {
    setAiState(false);
    addMessage('assistant', `AIå›ç­”ã‚¨ãƒ©ãƒ¼: ${data.error || 'unknown error'}`);
});

// Enterã‚­ãƒ¼ã§é€ä¿¡
document.getElementById('userInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

function setSendState(isSending) {
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = isSending;
    sendBtn.textContent = isSending ? 'å‡¦ç†ä¸­...' : 'é€ä¿¡';
}

function handleChatResponse(data) {
    setSendState(false);
    if (data.type === 'question') {
        addMessage('assistant', data.question);
        updateProgress(data.progress);
    } else if (data.type === 'knowledge_generated') {
        showGeneratedKnowledge(data);
    }
}

function sendMessage() {
    const input = document.getElementById('userInput');
    const message = input.value.trim();

    if (!message) return;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    addMessage('user', message);
    input.value = '';

    setSendState(true);

    socket.emit('chat_message', {
        session_id: sessionId,
        message: message,
        user_id: 'webui_user'
    });
}

function addMessage(role, content) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ' + role;

    const now = new Date().toLocaleTimeString('ja-JP');
    const roleText = role === 'user' ? 'ğŸ‘¤ ã‚ãªãŸ' : 'ğŸ¤– AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ';

    messageDiv.innerHTML = `
        <div class="message-header">
            <strong>${roleText}</strong>
            <span>${now}</span>
        </div>
        <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
    `;

    messagesDiv.appendChild(messageDiv);

    // ã‚¹ãƒ ãƒ¼ã‚ºãªè‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆDOMæ›´æ–°å¾Œã«å®Ÿè¡Œï¼‰
    requestAnimationFrame(() => {
        messagesDiv.scrollTo({
            top: messagesDiv.scrollHeight,
            behavior: 'smooth'
        });
    });

    conversationHistory.push({ role, content, timestamp: now });
}

function updateProgress(progress) {
    const percentage = progress.percentage;
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    progressFill.style.width = percentage + '%';
    progressText.textContent = percentage + '%';

    // åé›†çŠ¶æ³ã‚’æ›´æ–°
    const items = ['when', 'system', 'symptom', 'impact', 'response', 'cause', 'measures'];
    const labels = ['ğŸ“… ç™ºç”Ÿæ—¥æ™‚', 'ğŸ–¥ï¸ å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ', 'âš ï¸ ç—‡çŠ¶ãƒ»ã‚¨ãƒ©ãƒ¼', 'ğŸ‘¥ å½±éŸ¿ç¯„å›²', 'ğŸ”§ å¯¾å¿œå†…å®¹', 'ğŸ” åŸå› ', 'ğŸ“ ä»Šå¾Œã®å¯¾ç­–'];
    const infoDiv = document.getElementById('collectedInfo');

    infoDiv.innerHTML = '';
    items.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'collected-info-item ' + (progress.collected[item] ? 'collected' : 'missing');
        div.innerHTML = labels[index] + (progress.collected[item] ? ' âœ“' : '');
        infoDiv.appendChild(div);
    });

    // ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
    if (percentage >= 50) {
        document.getElementById('skipBtn').disabled = false;
    }
}

function showGeneratedKnowledge(data) {
    // ç”Ÿæˆå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    let message = `
        âœ… ãƒŠãƒ¬ãƒƒã‚¸ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼<br><br>
        <strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${data.title}<br>
        <strong>ITSMã‚¿ã‚¤ãƒ—:</strong> ${data.itsm_type} (ä¿¡é ¼åº¦: ${Math.round(data.confidence * 100)}%)<br><br>
        <strong>å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong><br>
        <div style="background: #f5f5f5; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; max-height: 200px; overflow-y: auto; white-space: pre-wrap;">${data.content.substring(0, 500)}...</div>
    `;

    if (data.similar_knowledge && data.similar_knowledge.length > 0) {
        message += `<br><br>âš ï¸ é¡ä¼¼ã™ã‚‹ãƒŠãƒ¬ãƒƒã‚¸ãŒ ${data.similar_knowledge.length} ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚`;
    }

    message += `<br><br>
        <button onclick="saveKnowledge('${data.title.replace(/'/g, "\\'")}', '${data.itsm_type}')" class="btn">ä¿å­˜ã™ã‚‹</button>
        <button onclick="editKnowledge()" class="btn btn-secondary" style="margin-left: 0.5rem;">ç·¨é›†ã™ã‚‹</button>
    `;

    addMessage('assistant', message);

    // ç”Ÿæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    window.generatedKnowledge = data;
}

async function saveKnowledge(title, itsmType) {
    const data = window.generatedKnowledge;

    try {
        const response = await fetch('/api/chat/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: data.title,
                content: data.content,
                itsm_type: data.itsm_type,
                session_id: sessionId,
                conversation_history: conversationHistory
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast('ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            setTimeout(() => {
                window.location.href = '/knowledge/' + result.knowledge_id + '?success=1&message=AIå¯¾è©±ã§ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä½œæˆã—ã¾ã—ãŸ';
            }, 1000);
        } else {
            showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    } catch (error) {
        showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }
}

function editKnowledge() {
    const data = window.generatedKnowledge;
    // é€šå¸¸ä½œæˆãƒšãƒ¼ã‚¸ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦é·ç§»
    const params = new URLSearchParams({
        title: data.title,
        content: data.content,
        itsm_type: data.itsm_type
    });
    window.location.href = '/knowledge/create?' + params.toString();
}

function skipToGenerate() {
    addMessage('user', 'ç¾åœ¨ã®æƒ…å ±ã§ç”Ÿæˆã—ã¦ãã ã•ã„');
    sendMessage();
}

function resetChat() {
    if (confirm('ä¼šè©±ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        sessionId = 'session_' + Date.now();
        conversationHistory = [];
        socket.emit('join_chat', { session_id: sessionId });
        collectedData = {
            when: null,
            system: null,
            symptom: null,
            impact: null,
            response: null,
            cause: null,
            measures: null
        };

        document.getElementById('chatMessages').innerHTML = `
            <div class="message assistant">
                <div class="message-header">
                    <strong>ğŸ¤– AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</strong>
                    <span>${new Date().toLocaleTimeString('ja-JP')}</span>
                </div>
                <div class="message-content">
                    ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚æœ€åˆã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼<br>
                    ã©ã‚“ãªäº‹è±¡ã«ã¤ã„ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ
                </div>
            </div>
        `;

        updateProgress({ percentage: 0, collected: collectedData });
        document.getElementById('skipBtn').disabled = true;
    }
}

// ========== AIè³ªå•æ©Ÿèƒ½ ==========

function setAiState(isAsking) {
    const btn = document.getElementById('askAiBtn');
    const input = document.getElementById('aiQuestionInput');
    btn.disabled = isAsking;
    btn.textContent = isAsking ? 'å‡¦ç†ä¸­...' : 'è³ªå•';
    input.disabled = isAsking;
}

async function askAI() {
    const input = document.getElementById('aiQuestionInput');
    const question = input.value.trim();

    if (!question) return;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’è¡¨ç¤º
    addMessage('user', `ğŸ” AIè³ªå•: ${question}`);
    input.value = '';

    setAiState(true);

    // REST APIçµŒç”±ã§AIå›ç­”ã‚’å–å¾—ï¼ˆã‚ˆã‚Šå®‰å®šï¼‰
    try {
        const response = await fetch('/api/chat/ai-answer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question: question,
                session_id: sessionId
            })
        });

        const data = await response.json();
        setAiState(false);

        if (data.success) {
            displayAiAnswer(data);
        } else {
            addMessage('assistant', `AIå›ç­”ã‚¨ãƒ©ãƒ¼: ${data.error || 'å›ç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ'}`);
        }
    } catch (error) {
        setAiState(false);
        addMessage('assistant', `AIå›ç­”ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
}

function displayAiAnswer(data) {
    // ä¿¡é ¼åº¦ã«å¿œã˜ãŸã‚¯ãƒ©ã‚¹ã¨è¡¨ç¤º
    let confidenceClass = 'confidence-low';
    let confidenceIcon = 'ğŸ”´';
    if (data.confidence >= 0.8) {
        confidenceClass = 'confidence-high';
        confidenceIcon = 'ğŸŸ¢';
    } else if (data.confidence >= 0.6) {
        confidenceClass = 'confidence-medium';
        confidenceIcon = 'ğŸŸ¡';
    }

    // AIä½¿ç”¨æƒ…å ±ï¼ˆå‡¦ç†ãƒ•ãƒ­ãƒ¼è¡¨ç¤ºï¼‰
    const aiUsed = data.ai_used || ['AI'];
    let processFlow = aiUsed.map((ai, idx) => {
        const icons = {
            'gemini': 'ğŸ” Geminiï¼ˆèª¿æŸ»ï¼‰',
            'perplexity': 'ğŸ“š Perplexityï¼ˆæ ¹æ‹ åé›†ï¼‰',
            'claude': 'ğŸ¤– Claudeï¼ˆçµ±åˆãƒ»å›ç­”ï¼‰',
            'anthropic': 'ğŸ¤– Claudeï¼ˆçµ±åˆãƒ»å›ç­”ï¼‰',
            'cached': 'âš¡ ã‚­ãƒ£ãƒƒã‚·ãƒ¥'
        };
        return icons[ai.toLowerCase()] || `ğŸ”· ${ai}`;
    }).join(' â†’ ');

    // å‡¦ç†æ™‚é–“
    const processingTime = data.processing_time_ms ? `${(data.processing_time_ms / 1000).toFixed(1)}ç§’` : '-';

    // å›ç­”HTMLæ§‹ç¯‰
    const answerId = Date.now();

    // å›ç­”ãƒ†ã‚­ã‚¹ãƒˆã‚’Markdowné¢¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    let formattedAnswer = data.answer
        .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre class="code-block"><code>$2</code></pre>')
        .replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/^\d+\.\s/gm, '<span class="list-number">$&</span>')
        .replace(/\n/g, '<br>');

    let answerHtml = `
        <div class="ai-answer-wrapper">
            <!-- å‡¦ç†ãƒ•ãƒ­ãƒ¼ -->
            <div class="ai-process-flow">
                <span class="process-label">âš™ï¸ å‡¦ç†ãƒ•ãƒ­ãƒ¼:</span>
                <span class="process-steps">${processFlow}</span>
            </div>

            <!-- å›ç­”æœ¬æ–‡ -->
            <div class="ai-answer-box">
                <div class="ai-answer-header">
                    ğŸ¤– AIå›ç­”
                </div>
                <div class="ai-answer-content">
                    ${formattedAnswer}
                </div>
            </div>
    `;

    // ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ãŒã‚ã‚‹å ´åˆ
    if (data.evidence && data.evidence.length > 0) {
        answerHtml += `
            <div class="ai-evidence-section">
                <div class="evidence-header">ğŸ“š æ ¹æ‹ ãƒ»ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹</div>
        `;
        data.evidence.forEach((ev, idx) => {
            const hasUrl = ev.url && ev.url.trim() !== '' && ev.url !== 'internal';
            answerHtml += `
                <div class="ai-evidence-item">
                    <div class="evidence-number">${idx + 1}</div>
                    <div class="evidence-content">
                        <div class="ai-evidence-source">
                            ğŸ“Œ ${ev.source || 'ã‚½ãƒ¼ã‚¹'}
                            ${hasUrl ? `<a href="${ev.url}" target="_blank" class="evidence-link">ğŸ”— ãƒªãƒ³ã‚¯</a>` : ''}
                        </div>
                        ${ev.snippet ? `<div class="evidence-snippet">${ev.snippet}</div>` : ''}
                    </div>
                </div>
            `;
        });
        answerHtml += '</div>';
    }

    // ã‚½ãƒ¼ã‚¹URLãŒã‚ã‚‹å ´åˆ
    if (data.sources && data.sources.length > 0) {
        const validSources = data.sources.filter(s => s && s.startsWith('http'));
        if (validSources.length > 0) {
            answerHtml += `
                <div class="ai-sources-section">
                    <span class="sources-label">ğŸ”— å‚ç…§å…ƒ:</span>
                    ${validSources.map(s => `<a href="${s}" target="_blank" class="source-link">${new URL(s).hostname}</a>`).join('')}
                </div>
            `;
        }
    }

    // ãƒ¡ã‚¿æƒ…å ±
    answerHtml += `
            <div class="ai-meta-bar">
                <div class="meta-item">
                    ${confidenceIcon} ä¿¡é ¼åº¦: <span class="${confidenceClass}">${Math.round(data.confidence * 100)}%</span>
                </div>
                <div class="meta-item">
                    â±ï¸ å‡¦ç†æ™‚é–“: ${processingTime}
                </div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="ai-answer-actions">
                <button onclick="saveAiAnswerAsKnowledge(${answerId})" class="btn btn-success">
                    ğŸ’¾ ãƒŠãƒ¬ãƒƒã‚¸ã¨ã—ã¦ä¿å­˜
                </button>
                <button onclick="editAiAnswer(${answerId})" class="btn btn-secondary">
                    âœï¸ ç·¨é›†ã—ã¦ä¿å­˜
                </button>
            </div>
        </div>
    `;

    // AIå›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆå¾Œã§ä½¿ç”¨ï¼‰
    window.aiAnswers = window.aiAnswers || {};
    window.aiAnswers[answerId] = {
        question: document.getElementById('aiQuestionInput').value,
        answer: data.answer,
        evidence: data.evidence || [],
        sources: data.sources || [],
        confidence: data.confidence,
        ai_used: data.ai_used
    };

    addMessage('assistant', answerHtml);
}

// AIå›ç­”ã‚’ãƒŠãƒ¬ãƒƒã‚¸ã¨ã—ã¦ä¿å­˜
async function saveAiAnswerAsKnowledge(answerId) {
    const data = window.aiAnswers[answerId];
    if (!data) {
        alert('å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    // ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆï¼ˆè³ªå•ã‚’ãƒ™ãƒ¼ã‚¹ã«ï¼‰
    const title = data.question.length > 50
        ? data.question.substring(0, 50) + '...'
        : data.question;

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
    let content = `## è³ªå•\n${data.question}\n\n## å›ç­”\n${data.answer}\n`;

    if (data.evidence && data.evidence.length > 0) {
        content += `\n## æ ¹æ‹ ãƒ»ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹\n`;
        data.evidence.forEach(ev => {
            content += `- **${ev.source || 'ã‚½ãƒ¼ã‚¹'}**: ${ev.snippet || ''}\n`;
            if (ev.url) content += `  - URL: ${ev.url}\n`;
        });
    }

    if (data.sources && data.sources.length > 0) {
        content += `\n## å‚ç…§å…ƒ\n`;
        data.sources.forEach(s => {
            content += `- ${s}\n`;
        });
    }

    content += `\n## ãƒ¡ã‚¿æƒ…å ±\n- ä¿¡é ¼åº¦: ${Math.round(data.confidence * 100)}%\n- AIä½¿ç”¨: ${data.ai_used ? data.ai_used.join(', ') : 'AI'}\n`;

    try {
        const response = await fetch('/api/chat/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title,
                content: content,
                itsm_type: 'faq',
                session_id: sessionId
            })
        });

        const result = await response.json();
        if (result.success) {
            alert('âœ… ãƒŠãƒ¬ãƒƒã‚¸ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸï¼');
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            event.target.disabled = true;
            event.target.textContent = 'âœ… ä¿å­˜æ¸ˆã¿';
        } else {
            alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || 'unknown error'));
        }
    } catch (error) {
        alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
    }
}

// AIå›ç­”ã‚’ç·¨é›†ã—ã¦ä¿å­˜ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
function editAiAnswer(answerId) {
    const data = window.aiAnswers[answerId];
    if (!data) {
        alert('å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    // ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
    const defaultTitle = data.question.length > 50
        ? data.question.substring(0, 50) + '...'
        : data.question;

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
    let content = `## è³ªå•\n${data.question}\n\n## å›ç­”\n${data.answer}\n`;

    if (data.evidence && data.evidence.length > 0) {
        content += `\n## æ ¹æ‹ ãƒ»ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹\n`;
        data.evidence.forEach(ev => {
            content += `- **${ev.source || 'ã‚½ãƒ¼ã‚¹'}**: ${ev.snippet || ''}\n`;
            if (ev.url) content += `  - URL: ${ev.url}\n`;
        });
    }

    // ç·¨é›†ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    window.generatedKnowledge = {
        title: defaultTitle,
        content: content,
        itsm_type: 'faq',
        ai_generated: true
    };

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§è¡¨ç¤º
    showGeneratedKnowledge(window.generatedKnowledge);
}

// åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
window.addEventListener('load', function() {
    setTimeout(() => {
        const hint = document.getElementById('keyboard-hint');
        if (hint) {
            hint.innerHTML = 'AIå¯¾è©±ãƒ¢ãƒ¼ãƒ‰: è³ªå•ã«ç­”ãˆã¦ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä½œæˆ';
            hint.classList.add('show');
            setTimeout(() => hint.classList.remove('show'), 5000);
        }
    }, 500);
});
</script>
{% endblock %}
