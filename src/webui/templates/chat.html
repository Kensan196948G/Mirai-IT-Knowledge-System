{% extends "base.html" %}

{% block title %}AIå¯¾è©±ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ - Mirai IT Knowledge Systems{% endblock %}

{% block breadcrumb %}{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/sample7.css') }}">
<style>
    .main { padding: 1.5rem 0; }
    .chat-container { margin-top: 1rem; }
    .ai-processing { overflow-x: auto; }
    .ai-pipeline { flex-wrap: nowrap; align-items: stretch; }
    .pipeline-stage { min-width: 170px; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 0.25rem; }
    .pipeline-arrow { white-space: nowrap; }

    /* Chat Mode Selector */
    .chat-mode-selector {
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        border-radius: 12px;
        border: 2px solid rgba(102, 126, 234, 0.1);
    }

    .mode-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .mode-btn {
        padding: 1.5rem;
        border: 2px solid #ddd;
        background: white;
        cursor: pointer;
        border-radius: 12px;
        transition: all 0.3s ease;
        text-align: center;
        font-family: inherit;
        font-size: 1rem;
    }

    .mode-btn:hover {
        border-color: var(--color-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .mode-btn.active {
        border-color: #4CAF50;
        background: #E8F5E9;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
    }
    .pulse-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin: 0.35rem auto 0;
        background: #c9c9c9;
        opacity: 0.35;
    }
    .pipeline-stage.active .pulse-dot,
    .pipeline-stage.processing .pulse-dot {
        background: var(--color-primary);
        opacity: 1;
        animation: pulseDot 1s ease-in-out infinite;
    }
    .pipeline-stage.completed .pulse-dot {
        background: #4caf50;
        opacity: 1;
    }
    @keyframes pulseDot {
        0% { transform: scale(0.8); opacity: 0.4; }
        50% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(0.8); opacity: 0.4; }
    }
    .chat-message-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-top: 0.5rem;
        padding: 0.4rem 0.6rem;
        border-radius: 8px;
        background: #f7f7f9;
        border: 1px solid #e6e6e6;
        font-size: 0.85rem;
        flex-wrap: wrap;
    }
    .chat-message-actions button {
        border: none;
        background: white;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        cursor: pointer;
        border: 1px solid #ddd;
    }
    .chat-message-actions button:hover {
        border-color: var(--color-primary);
        color: var(--color-primary);
    }
    .chat-message-actions .action-status {
        color: #666;
        margin-left: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">AIå¯¾è©±ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h1>
        <p class="page-subtitle">AIã¨å¯¾è©±ã—ã¦ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä½œæˆ</p>
    </div>
</div>

<div class="chat-mode-selector">
    <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">AIå¯¾è©±ã®ç›®çš„ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
    <div class="mode-buttons">
        <button class="mode-btn active" data-mode="knowledge" onclick="setSessionType('knowledge')">
            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ğŸ“š</div>
            <strong>ãƒŠãƒ¬ãƒƒã‚¸ä½œæˆ</strong>
            <small style="display: block; margin-top: 0.25rem; opacity: 0.8;">å•é¡Œè§£æ±ºãƒ»æ‰‹é †æ›¸ä½œæˆ</small>
        </button>
        <button class="mode-btn" data-mode="faq" onclick="setSessionType('faq')">
            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">â“</div>
            <strong>FAQä½œæˆ</strong>
            <small style="display: block; margin-top: 0.25rem; opacity: 0.8;">ã‚ˆãã‚ã‚‹è³ªå•ãƒ»å›ç­”</small>
        </button>
    </div>
</div>

<div class="chat-container">
    <div class="chat-sidebar">
        <div class="chat-sidebar-header">
            <h3>ä¼šè©±å±¥æ­´</h3>
            <div class="chat-sidebar-actions">
                <button class="btn-icon" id="newChatBtn" title="æ–°è¦">â•</button>
            </div>
        </div>
        <div class="chat-history-list" id="chatHistoryList"></div>
    </div>

    <div class="chat-main">
        <div class="chat-toolbar">
            <div class="chat-toolbar-title">æ–°ã—ã„è³ªå•</div>
            <button class="btn btn-secondary btn-sm" id="reloadChatBtn">ãƒªãƒ­ãƒ¼ãƒ‰</button>
        </div>
        <div class="chat-messages-area" id="aiChatMessages">
            <div class="chat-system-message">
                <div class="system-title">ğŸ‘‹ ã“ã‚“ã«ã¡ã¯ï¼</div>
                <p class="system-text">ç¤¾å†…ã®æ‰‹é †ã‚„ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œã«ã¤ã„ã¦ä½•ã§ã‚‚è³ªå•ã—ã¦ãã ã•ã„ã€‚</p>
                <div class="quick-questions">
                    <span class="quick-label">ã‚ˆãã‚ã‚‹è³ªå•:</span>
                    <div class="quick-buttons">
                        <button class="quick-btn" data-question="VPNæ¥ç¶šãŒã§ããªã„æ™‚ã®å¯¾å‡¦æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„">VPNæ¥ç¶š</button>
                        <button class="quick-btn" data-question="ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒé…ã„æ™‚ã®ç¢ºèªæ‰‹é †ã‚’æ•™ãˆã¦ãã ã•ã„">ãƒ¡ãƒ¼ãƒ«é…å»¶</button>
                        <button class="quick-btn" data-question="çµŒè²»ç²¾ç®—ã®æ‰‹é †ã‚’æ•™ãˆã¦ãã ã•ã„">çµŒè²»ç²¾ç®—</button>
                        <button class="quick-btn" data-question="æœ‰çµ¦ä¼‘æš‡ã®ç”³è«‹æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„">æœ‰çµ¦ä¼‘æš‡</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="ai-processing" id="aiChatProcessing" style="display: none;">
            <div class="ai-processing-header">
                <span class="processing-icon">âš¡</span>
                <span>AIå‡¦ç†ä¸­...</span>
            </div>
            <div class="ai-pipeline">
                <div class="pipeline-stage" id="chatStage1">
                    <div class="stage-icon">ğŸ§ </div>
                    <div class="pulse-dot"></div>
                    <div class="stage-info">
                        <span class="stage-name">Claude</span>
                        <span class="stage-desc">åˆæœŸå›ç­”ç”Ÿæˆ</span>
                    </div>
                    <div class="pipeline-indicator waiting"></div>
                </div>
                <div class="pipeline-arrow">â†’</div>
                <div class="pipeline-stage" id="chatStage2">
                    <div class="stage-icon">ğŸ”®</div>
                    <div class="pulse-dot"></div>
                    <div class="stage-info">
                        <span class="stage-name">Gemini</span>
                        <span class="stage-desc">æ¤œè¨¼ãƒ»è£œå®Œ</span>
                    </div>
                    <div class="pipeline-indicator waiting"></div>
                </div>
                <div class="pipeline-arrow">â†’</div>
                <div class="pipeline-stage" id="chatStage3">
                    <div class="stage-icon">ğŸŒ</div>
                    <div class="pulse-dot"></div>
                    <div class="stage-info">
                        <span class="stage-name">Perplexity</span>
                        <span class="stage-desc">æœ€æ–°æƒ…å ±ç¢ºèª</span>
                    </div>
                    <div class="pipeline-indicator waiting"></div>
                </div>
            </div>
            <div class="processing-message" id="chatProcessingMessage">
                <p>æº–å‚™ä¸­...</p>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="chat-input-box">
                <textarea class="chat-textarea" id="aiChatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
                <button class="btn-send-chat" id="aiChatSendBtn" onclick="sendMessage()">
                    <span>é€ä¿¡</span>
                </button>
            </div>
            <div class="input-hint">Enter ã§é€ä¿¡ / Shift + Enter ã§æ”¹è¡Œ</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js" crossorigin="anonymous"></script>
<script>
let sessionType = 'knowledge';
let sessionId = 'session_knowledge_' + Date.now();
let conversationHistory = [];
let messageCounter = 0;
let collectedData = {
    when: null,
    system: null,
    symptom: null,
    impact: null,
    response: null,
    cause: null,
    measures: null
};
let chatPending = { handled: false, timer: null };
const quickAnswerMap = {
    'VPNæ¥ç¶šãŒã§ããªã„æ™‚ã®å¯¾å‡¦æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„': {
        title: 'VPNæ¥ç¶šãƒˆãƒ©ãƒ–ãƒ«ã®ä¸€æ¬¡å¯¾å¿œ',
        steps: [
            'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šï¼ˆWiâ€‘Fi/æœ‰ç·šï¼‰ã‚’å†ç¢ºèªã—ã€å†æ¥ç¶š',
            'VPNã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å†èµ·å‹•ã—ã€è³‡æ ¼æƒ…å ±ã‚’å†å…¥åŠ›',
            'ç¤¾å†…VPNãƒãƒ¼ã‚¿ãƒ«ã®éšœå®³æƒ…å ±ãƒ»ãƒ¡ãƒ³ãƒ†ç”»é¢ã‚’ç¢ºèª',
            'ç«¯æœ«ã®æ™‚åˆ»åŒæœŸã¨è¨¼æ˜æ›¸ã®æœ‰åŠ¹æœŸé™ã‚’ç¢ºèª',
            'ç¤¾å†…DNS/ãƒ—ãƒ­ã‚­ã‚·è¨­å®šã®å¤‰æ›´æœ‰ç„¡ã‚’ç¢ºèª'
        ],
        note: 'è§£æ¶ˆã—ãªã„å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ç™ºç”Ÿæ™‚åˆ»ã‚’æ·»ãˆã¦ITã¸é€£çµ¡ã€‚'
    },
    'ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒé…ã„æ™‚ã®ç¢ºèªæ‰‹é †ã‚’æ•™ãˆã¦ãã ã•ã„': {
        title: 'ãƒ¡ãƒ¼ãƒ«é…å»¶æ™‚ã®ç¢ºèªãƒã‚¤ãƒ³ãƒˆ',
        steps: [
            'Outboxã®æ»ç•™æœ‰ç„¡ã¨æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã‚’ç¢ºèª',
            'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®é€ä¿¡ã‚µãƒ¼ãƒãƒ¼è¨­å®šï¼ˆSMTPï¼‰ã‚’å†æ¥ç¶š',
            'ç¤¾å†…/ã‚¯ãƒ©ã‚¦ãƒ‰ã®éšœå®³æƒ…å ±ãƒ»é…å»¶ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç¢ºèª',
            'å—ä¿¡å´ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ/é…å»¶å ±å‘Šã‚’ç¢ºèª',
            'å†é€ãƒ†ã‚¹ãƒˆï¼ˆå°å®¹é‡ãƒ»åˆ¥å®›å…ˆï¼‰ã§åˆ‡ã‚Šåˆ†ã‘'
        ],
        note: 'å¤§å®¹é‡æ·»ä»˜ã¯åˆ†å‰² or å…±æœ‰ãƒªãƒ³ã‚¯ã«åˆ‡æ›¿æ¨å¥¨ã€‚'
    },
    'çµŒè²»ç²¾ç®—ã®æ‰‹é †ã‚’æ•™ãˆã¦ãã ã•ã„': {
        title: 'çµŒè²»ç²¾ç®—ï¼ˆåŸºæœ¬ãƒ•ãƒ­ãƒ¼ï¼‰',
        steps: [
            'çµŒè²»ç²¾ç®—ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³',
            'ç”³è«‹ä½œæˆ â†’ æ˜ç´°å…¥åŠ›ï¼ˆè²»ç›®/é‡‘é¡/æ—¥ä»˜ï¼‰',
            'é ˜åæ›¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæ’®å½±ç”»åƒã§ã‚‚å¯ï¼‰',
            'ä¸Šé•·æ‰¿èªãƒ«ãƒ¼ãƒˆã‚’æŒ‡å®šã—ã¦ç”³è«‹',
            'æ‰¿èªå®Œäº†å¾Œã€æ”¯æ‰•æ—¥ã«æŒ¯è¾¼'
        ],
        note: 'é ˜åæ›¸ã¯åŸæœ¬ä¿ç®¡ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚'
    },
    'æœ‰çµ¦ä¼‘æš‡ã®ç”³è«‹æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„': {
        title: 'æœ‰çµ¦ä¼‘æš‡ã®ç”³è«‹æ–¹æ³•',
        steps: [
            'å‹¤æ€ /äººäº‹ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³',
            'ä¼‘æš‡ç”³è«‹ â†’ æœ‰çµ¦ä¼‘æš‡ã‚’é¸æŠ',
            'å–å¾—æ—¥/ç†ç”±ï¼ˆå¿…è¦ãªå ´åˆï¼‰ã‚’å…¥åŠ›',
            'ä»£ç†å¯¾å¿œè€…/å¼•ç¶™ãäº‹é …ã‚’è¨˜å…¥',
            'ä¸Šé•·æ‰¿èª â†’ åæ˜ ç¢ºèª'
        ],
        note: 'ç¹å¿™æœŸã¯äº‹å‰ç›¸è«‡ã®ä¸Šã€æ—©ã‚ã«ç”³è«‹ã—ã¦ãã ã•ã„ã€‚'
    }
};

function setSessionType(type) {
    sessionType = type;

    // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-mode="${type}"]`).classList.add('active');

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDå†ç”Ÿæˆï¼ˆãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ™‚ï¼‰
    sessionId = 'session_' + type + '_' + Date.now();

    console.log(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã‚’ ${type} ã«å¤‰æ›´ã—ã¾ã—ãŸ (ID: ${sessionId})`);
}

const socket = io({
    transports: ['polling'],
    upgrade: false
});

socket.on('connect', () => {
    socket.emit('join_chat', { session_id: sessionId });
});

socket.on('chat_response', (data) => {
    handleChatResponse(data);
});

socket.on('chat_generated', (data) => {
    setSendState(false);
    showGeneratedKnowledge(data);
});

socket.on('chat_error', (data) => {
    handleChatError(data.error || 'unknown error');
});

const inputEl = document.getElementById('aiChatInput');
inputEl.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

attachQuickButtons();

function setSendState(isSending) {
    const sendBtn = document.getElementById('aiChatSendBtn');
    sendBtn.disabled = isSending;
    sendBtn.textContent = isSending ? 'å‡¦ç†ä¸­...' : 'é€ä¿¡';
}

function handleChatResponse(data) {
    if (chatPending.handled) return;
    chatPending.handled = true;
    if (chatPending.timer) {
        clearTimeout(chatPending.timer);
        chatPending.timer = null;
    }
    setSendState(false);
    hideProcessing();
    if (data.type === 'question') {
        addMessage('assistant', data.question);
        updateProgress(data.progress);
    } else if (data.type === 'knowledge_generated') {
        showGeneratedKnowledge(data);
    }
}

function handleChatError(message) {
    if (chatPending.handled) return;
    chatPending.handled = true;
    if (chatPending.timer) {
        clearTimeout(chatPending.timer);
        chatPending.timer = null;
    }
    setSendState(false);
    hideProcessing();
    addMessage('assistant', `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${message || 'unknown error'}`);
}

function sendMessage() {
    const message = inputEl.value.trim();
    if (!message) return;

    addMessage('user', message);
    inputEl.value = '';

    setSendState(true);
    showProcessing('å›ç­”ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...');

    chatPending.handled = false;
    if (chatPending.timer) clearTimeout(chatPending.timer);
    chatPending.timer = setTimeout(async () => {
        if (chatPending.handled) return;
        try {
            const response = await fetch('/api/chat/message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: sessionId,
                    message: message,
                    user_id: 'webui_user',
                    session_type: sessionType
                })
            });
            const data = await response.json();
            handleChatResponse(data);
        } catch (error) {
            handleChatError(error.message);
        }
    }, 8000);

    socket.emit('chat_message', {
        session_id: sessionId,
        message: message,
        user_id: 'webui_user',
        session_type: sessionType
    });
}

function addMessage(role, content) {
    const messagesDiv = document.getElementById('aiChatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = role === 'user' ? 'chat-message user' : 'chat-message assistant';
    const messageId = `msg_${Date.now()}_${++messageCounter}`;
    messageDiv.dataset.messageId = messageId;

    const now = new Date().toLocaleTimeString('ja-JP');
    const roleText = role === 'user' ? 'ğŸ‘¤ ã‚ãªãŸ' : 'ğŸ¤– AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ';

    messageDiv.innerHTML = `
        <div class="message-avatar">${role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
        <div class="message-content">
            <div class="message-header">
                <strong>${roleText}</strong>
                <span>${now}</span>
            </div>
            <div class="message-text">${content.replace(/\n/g, '<br>')}</div>
        </div>
    `;

    if (role === 'assistant') {
        const actions = document.createElement('div');
        actions.className = 'chat-message-actions';
        actions.innerHTML = `
            <button type="button" data-action="copy">ã‚³ãƒ”ãƒ¼</button>
            <button type="button" data-action="export-txt">TXT</button>
            <button type="button" data-action="export-md">Markdown</button>
            <button type="button" data-action="like">ã„ã„ã­</button>
            <button type="button" data-action="dislike">ã‚ã‚‹ã„ã­</button>
            <span class="action-status" data-action-status> </span>
        `;
        actions.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const action = btn.getAttribute('data-action');
            handleChatAction(messageDiv, action);
        });
        const contentBox = messageDiv.querySelector('.message-content');
        if (contentBox) {
            contentBox.appendChild(actions);
        } else {
            messageDiv.appendChild(actions);
        }
    }

    messagesDiv.appendChild(messageDiv);
    requestAnimationFrame(() => {
        messagesDiv.scrollTo({ top: messagesDiv.scrollHeight, behavior: 'smooth' });
    });

    conversationHistory.push({ role, content, timestamp: now, message_id: messageId });
}

function updateProgress(progress) {
    // é€²æ—è¡¨ç¤ºã¯ç°¡ç•¥åŒ–ï¼ˆUIæœªå®Ÿè£…ï¼‰
    if (progress && progress.percentage >= 50) {
        const history = document.getElementById('chatHistoryList');
        if (history && history.children.length === 0) {
            const item = document.createElement('div');
            item.className = 'chat-history-item active';
            item.textContent = 'ãƒŠãƒ¬ãƒƒã‚¸ä½œæˆä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³';
            history.appendChild(item);
        }
    }
}

function addHistoryItem(label) {
    const history = document.getElementById('chatHistoryList');
    if (!history) return;
    const item = document.createElement('div');
    item.className = 'chat-history-item';
    item.textContent = label;
    history.prepend(item);
}

function getMessagePlainText(messageDiv) {
    const content = messageDiv.querySelector('.message-content');
    return content ? content.innerText.trim() : '';
}

function downloadTextFile(filename, text) {
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

async function handleChatAction(messageDiv, action) {
    const status = messageDiv.querySelector('[data-action-status]');
    const messageId = messageDiv.dataset.messageId || '';
    const text = getMessagePlainText(messageDiv);
    if (!text) return;

    if (action === 'copy') {
        await navigator.clipboard.writeText(text);
        if (status) status.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
        return;
    }

    if (action === 'export-txt') {
        downloadTextFile('ai_answer.txt', text);
        if (status) status.textContent = 'TXTã‚’ä¿å­˜ã—ã¾ã—ãŸ';
        return;
    }

    if (action === 'export-md') {
        const md = `# AIå›ç­”\n\n${text}\n`;
        downloadTextFile('ai_answer.md', md);
        if (status) status.textContent = 'Markdownã‚’ä¿å­˜ã—ã¾ã—ãŸ';
        return;
    }

    if (action === 'like' || action === 'dislike') {
        const rating = action === 'like' ? 1 : -1;
        try {
            await fetch('/api/chat/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: sessionId,
                    message_id: messageId,
                    rating: rating,
                    user_id: 'webui_user'
                })
            });
            if (status) status.textContent = action === 'like' ? 'ğŸ‘ é€ä¿¡æ¸ˆã¿' : 'ğŸ‘ é€ä¿¡æ¸ˆã¿';
        } catch (e) {
            if (status) status.textContent = 'é€ä¿¡å¤±æ•—';
        }
    }
}

function attachQuickButtons() {
    const quickButtons = document.querySelectorAll('.quick-btn');
    quickButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const question = btn.getAttribute('data-question');
            if (question) {
                inputEl.value = question;
                inputEl.focus();
                const canned = quickAnswerMap[question];
                if (canned) {
                    addMessage('user', question);
                    const html = `
                        <div style="margin-bottom: 0.5rem;"><strong>âœ… ${canned.title}</strong></div>
                        <ol style="margin: 0 0 0.75rem 1.25rem;">
                            ${canned.steps.map(s => `<li>${s}</li>`).join('')}
                        </ol>
                        <div style="background: #f6fbff; border-left: 3px solid var(--color-primary); padding: 0.5rem 0.75rem; border-radius: 4px;">
                            ğŸ’¡ ${canned.note}
                        </div>
                    `;
                    addMessage('assistant', html);
                    addHistoryItem(`ã‚ˆãã‚ã‚‹è³ªå•: ${canned.title}`);
                } else {
                    sendMessage();
                }
            }
        });
    });
}

function resetStages() {
    ['chatStage1', 'chatStage2', 'chatStage3'].forEach(id => {
        const stage = document.getElementById(id);
        if (!stage) return;
        stage.classList.remove('active', 'completed');
        const indicator = stage.querySelector('.pipeline-indicator');
        if (indicator) indicator.className = 'pipeline-indicator waiting';
    });
}

function updateStage(step, status) {
    const stage = document.getElementById(`chatStage${step}`);
    if (!stage) return;
    stage.classList.remove('active', 'completed');
    const indicator = stage.querySelector('.pipeline-indicator');
    if (indicator) indicator.className = `pipeline-indicator ${status}`;
    if (status === 'processing') stage.classList.add('active');
    if (status === 'completed') stage.classList.add('completed');
}

function showProcessing(text) {
    const processing = document.getElementById('aiChatProcessing');
    const processingMessage = document.getElementById('chatProcessingMessage');
    if (!processing) return;
    processing.style.display = 'block';
    if (processingMessage) processingMessage.textContent = text || 'å‡¦ç†ä¸­...';
    resetStages();
    updateStage(1, 'processing');
    if (window.__chatStageTimers) {
        window.__chatStageTimers.forEach(t => clearTimeout(t));
    }
    window.__chatStageTimers = [
        setTimeout(() => updateStage(1, 'completed'), 400),
        setTimeout(() => updateStage(2, 'processing'), 450),
        setTimeout(() => updateStage(2, 'completed'), 1100),
        setTimeout(() => updateStage(3, 'processing'), 1150),
        setTimeout(() => updateStage(3, 'completed'), 1900),
    ];
}

function hideProcessing() {
    const processing = document.getElementById('aiChatProcessing');
    if (!processing) return;
    if (window.__chatStageTimers) {
        window.__chatStageTimers.forEach(t => clearTimeout(t));
        window.__chatStageTimers = null;
    }
    updateStage(1, 'completed');
    updateStage(2, 'completed');
    updateStage(3, 'completed');
    setTimeout(() => {
        processing.style.display = 'none';
    }, 300);
}

function showGeneratedKnowledge(data) {
    let message = `
        âœ… ãƒŠãƒ¬ãƒƒã‚¸ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼<br><br>
        <strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${data.title}<br>
        <strong>ITSMã‚¿ã‚¤ãƒ—:</strong> ${data.itsm_type} (ä¿¡é ¼åº¦: ${Math.round(data.confidence * 100)}%)<br><br>
        <strong>å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong><br>
        <div style="background: #f5f5f5; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; max-height: 200px; overflow-y: auto; white-space: pre-wrap;">${data.content.substring(0, 500)}...</div>
        <br>
        <button onclick="saveKnowledge('${data.title.replace(/'/g, "\\'")}', '${data.itsm_type}')" class="btn btn-primary">ä¿å­˜ã™ã‚‹</button>
        <button onclick="editKnowledge()" class="btn btn-secondary" style="margin-left: 0.5rem;">ç·¨é›†ã™ã‚‹</button>
    `;

    addMessage('assistant', message);
    window.generatedKnowledge = data;
}

async function saveKnowledge(title, itsmType) {
    const data = window.generatedKnowledge;
    try {
        const response = await fetch('/api/chat/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: data.title,
                content: data.content,
                itsm_type: data.itsm_type,
                session_id: sessionId,
                conversation_history: conversationHistory
            })
        });

        const result = await response.json();
        if (result.success) {
            window.location.href = '/knowledge/' + result.knowledge_id + '?success=1&message=AIå¯¾è©±ã§ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä½œæˆã—ã¾ã—ãŸ';
        } else {
            addMessage('assistant', 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        addMessage('assistant', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}

function editKnowledge() {
    const data = window.generatedKnowledge;
    const params = new URLSearchParams({
        title: data.title,
        content: data.content,
        itsm_type: data.itsm_type
    });
    window.location.href = '/knowledge/create?' + params.toString();
}

document.getElementById('newChatBtn').addEventListener('click', () => {
    sessionId = 'session_' + sessionType + '_' + Date.now();
    conversationHistory = [];
    socket.emit('join_chat', { session_id: sessionId });
    document.getElementById('aiChatMessages').innerHTML = `
        <div class="chat-system-message">
            <div class="system-title">ğŸ‘‹ ã“ã‚“ã«ã¡ã¯ï¼</div>
            <p class="system-text">ç¤¾å†…ã®æ‰‹é †ã‚„ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œã«ã¤ã„ã¦ä½•ã§ã‚‚è³ªå•ã—ã¦ãã ã•ã„ã€‚</p>
            <div class="quick-questions">
                <span class="quick-label">ã‚ˆãã‚ã‚‹è³ªå•:</span>
                <div class="quick-buttons">
                    <button class="quick-btn" data-question="VPNæ¥ç¶šãŒã§ããªã„æ™‚ã®å¯¾å‡¦æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„">VPNæ¥ç¶š</button>
                    <button class="quick-btn" data-question="ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒé…ã„æ™‚ã®ç¢ºèªæ‰‹é †ã‚’æ•™ãˆã¦ãã ã•ã„">ãƒ¡ãƒ¼ãƒ«é…å»¶</button>
                    <button class="quick-btn" data-question="çµŒè²»ç²¾ç®—ã®æ‰‹é †ã‚’æ•™ãˆã¦ãã ã•ã„">çµŒè²»ç²¾ç®—</button>
                    <button class="quick-btn" data-question="æœ‰çµ¦ä¼‘æš‡ã®ç”³è«‹æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„">æœ‰çµ¦ä¼‘æš‡</button>
                </div>
            </div>
        </div>
    `;
    document.getElementById('chatHistoryList').innerHTML = '';
    attachQuickButtons();
});

document.getElementById('reloadChatBtn').addEventListener('click', () => {
    window.location.reload();
});
</script>
{% endblock %}
