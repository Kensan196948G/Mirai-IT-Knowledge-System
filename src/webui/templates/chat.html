{% extends "base.html" %}

{% block title %}AIå¯¾è©±ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ - Mirai IT Knowledge Systems{% endblock %}

{% block breadcrumb %}{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/sample7.css') }}">
<style>
    .main { padding: 1.5rem 0; }
    .chat-container { margin-top: 1rem; }
    .ai-processing { overflow-x: auto; }
    .ai-pipeline { flex-wrap: nowrap; }
    .pipeline-stage { min-width: 170px; }
    .pipeline-arrow { white-space: nowrap; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">AIå¯¾è©±ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h1>
        <p class="page-subtitle">AIã¨å¯¾è©±ã—ã¦ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä½œæˆ</p>
    </div>
</div>

<div class="chat-container">
    <div class="chat-sidebar">
        <div class="chat-sidebar-header">
            <h3>ä¼šè©±å±¥æ­´</h3>
            <div class="chat-sidebar-actions">
                <button class="btn-icon" id="newChatBtn" title="æ–°è¦">â•</button>
            </div>
        </div>
        <div class="chat-history-list" id="chatHistoryList"></div>
    </div>

    <div class="chat-main">
        <div class="chat-toolbar">
            <div class="chat-toolbar-title">æ–°ã—ã„è³ªå•</div>
            <button class="btn btn-secondary btn-sm" id="reloadChatBtn">ãƒªãƒ­ãƒ¼ãƒ‰</button>
        </div>
        <div class="chat-messages-area" id="aiChatMessages">
            <div class="chat-system-message">
                <div class="system-title">ğŸ‘‹ ã“ã‚“ã«ã¡ã¯ï¼</div>
                <p class="system-text">ç¤¾å†…ã®æ‰‹é †ã‚„ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œã«ã¤ã„ã¦ä½•ã§ã‚‚è³ªå•ã—ã¦ãã ã•ã„ã€‚</p>
                <div class="quick-questions">
                    <span class="quick-label">ã‚ˆãã‚ã‚‹è³ªå•:</span>
                    <div class="quick-buttons">
                        <button class="quick-btn" data-question="VPNæ¥ç¶šãŒã§ããªã„æ™‚ã®å¯¾å‡¦æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„">VPNæ¥ç¶š</button>
                        <button class="quick-btn" data-question="ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒé…ã„æ™‚ã®ç¢ºèªæ‰‹é †ã‚’æ•™ãˆã¦ãã ã•ã„">ãƒ¡ãƒ¼ãƒ«é…å»¶</button>
                        <button class="quick-btn" data-question="çµŒè²»ç²¾ç®—ã®æ‰‹é †ã‚’æ•™ãˆã¦ãã ã•ã„">çµŒè²»ç²¾ç®—</button>
                        <button class="quick-btn" data-question="æœ‰çµ¦ä¼‘æš‡ã®ç”³è«‹æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„">æœ‰çµ¦ä¼‘æš‡</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="ai-processing" id="aiChatProcessing" style="display: none;">
            <div class="ai-processing-header">
                <span class="processing-icon">âš¡</span>
                <span>AIå‡¦ç†ä¸­...</span>
            </div>
            <div class="ai-pipeline">
                <div class="pipeline-stage" id="chatStage1">
                    <div class="stage-icon">ğŸ§ </div>
                    <div class="stage-info">
                        <span class="stage-name">Claude</span>
                        <span class="stage-desc">åˆæœŸå›ç­”ç”Ÿæˆ</span>
                    </div>
                    <div class="pipeline-indicator waiting"></div>
                </div>
                <div class="pipeline-arrow">â†’</div>
                <div class="pipeline-stage" id="chatStage2">
                    <div class="stage-icon">ğŸ”®</div>
                    <div class="stage-info">
                        <span class="stage-name">Gemini</span>
                        <span class="stage-desc">æ¤œè¨¼ãƒ»è£œå®Œ</span>
                    </div>
                    <div class="pipeline-indicator waiting"></div>
                </div>
                <div class="pipeline-arrow">â†’</div>
                <div class="pipeline-stage" id="chatStage3">
                    <div class="stage-icon">ğŸŒ</div>
                    <div class="stage-info">
                        <span class="stage-name">Perplexity</span>
                        <span class="stage-desc">æœ€æ–°æƒ…å ±ç¢ºèª</span>
                    </div>
                    <div class="pipeline-indicator waiting"></div>
                </div>
            </div>
            <div class="processing-message" id="chatProcessingMessage">
                <p>æº–å‚™ä¸­...</p>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="chat-input-box">
                <textarea class="chat-textarea" id="aiChatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
                <button class="btn-send-chat" id="aiChatSendBtn" onclick="sendMessage()">
                    <span>é€ä¿¡</span>
                </button>
            </div>
            <div class="input-hint">Enter ã§é€ä¿¡ / Shift + Enter ã§æ”¹è¡Œ</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js" crossorigin="anonymous"></script>
<script>
let sessionId = 'session_' + Date.now();
let conversationHistory = [];
let collectedData = {
    when: null,
    system: null,
    symptom: null,
    impact: null,
    response: null,
    cause: null,
    measures: null
};

const socket = io({
    transports: ['polling'],
    upgrade: false
});

socket.on('connect', () => {
    socket.emit('join_chat', { session_id: sessionId });
});

socket.on('chat_response', (data) => {
    handleChatResponse(data);
});

socket.on('chat_generated', (data) => {
    setSendState(false);
    showGeneratedKnowledge(data);
});

socket.on('chat_error', (data) => {
    setSendState(false);
    hideProcessing();
    addMessage('assistant', `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${data.error || 'unknown error'}`);
});

const inputEl = document.getElementById('aiChatInput');
inputEl.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

attachQuickButtons();

function setSendState(isSending) {
    const sendBtn = document.getElementById('aiChatSendBtn');
    sendBtn.disabled = isSending;
    sendBtn.textContent = isSending ? 'å‡¦ç†ä¸­...' : 'é€ä¿¡';
}

function handleChatResponse(data) {
    setSendState(false);
    hideProcessing();
    if (data.type === 'question') {
        addMessage('assistant', data.question);
        updateProgress(data.progress);
    } else if (data.type === 'knowledge_generated') {
        showGeneratedKnowledge(data);
    }
}

function sendMessage() {
    const message = inputEl.value.trim();
    if (!message) return;

    addMessage('user', message);
    inputEl.value = '';

    setSendState(true);
    showProcessing('å›ç­”ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...');

    socket.emit('chat_message', {
        session_id: sessionId,
        message: message,
        user_id: 'webui_user'
    });
}

function addMessage(role, content) {
    const messagesDiv = document.getElementById('aiChatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = role === 'user' ? 'chat-message user-message' : 'chat-message ai-message';

    const now = new Date().toLocaleTimeString('ja-JP');
    const roleText = role === 'user' ? 'ğŸ‘¤ ã‚ãªãŸ' : 'ğŸ¤– AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ';

    messageDiv.innerHTML = `
        <div class="message-header">
            <strong>${roleText}</strong>
            <span>${now}</span>
        </div>
        <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
    `;

    messagesDiv.appendChild(messageDiv);
    requestAnimationFrame(() => {
        messagesDiv.scrollTo({ top: messagesDiv.scrollHeight, behavior: 'smooth' });
    });

    conversationHistory.push({ role, content, timestamp: now });
}

function updateProgress(progress) {
    // é€²æ—è¡¨ç¤ºã¯ç°¡ç•¥åŒ–ï¼ˆUIæœªå®Ÿè£…ï¼‰
    if (progress && progress.percentage >= 50) {
        const history = document.getElementById('chatHistoryList');
        if (history && history.children.length === 0) {
            const item = document.createElement('div');
            item.className = 'chat-history-item active';
            item.textContent = 'ãƒŠãƒ¬ãƒƒã‚¸ä½œæˆä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³';
            history.appendChild(item);
        }
    }
}

function attachQuickButtons() {
    const quickButtons = document.querySelectorAll('.quick-btn');
    quickButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const question = btn.getAttribute('data-question');
            if (question) {
                inputEl.value = question;
                inputEl.focus();
            }
        });
    });
}

function resetStages() {
    ['chatStage1', 'chatStage2', 'chatStage3'].forEach(id => {
        const stage = document.getElementById(id);
        if (!stage) return;
        stage.classList.remove('active', 'completed');
        const indicator = stage.querySelector('.pipeline-indicator');
        if (indicator) indicator.className = 'pipeline-indicator waiting';
    });
}

function updateStage(step, status) {
    const stage = document.getElementById(`chatStage${step}`);
    if (!stage) return;
    stage.classList.remove('active', 'completed');
    const indicator = stage.querySelector('.pipeline-indicator');
    if (indicator) indicator.className = `pipeline-indicator ${status}`;
    if (status === 'processing') stage.classList.add('active');
    if (status === 'completed') stage.classList.add('completed');
}

function showProcessing(text) {
    const processing = document.getElementById('aiChatProcessing');
    const processingMessage = document.getElementById('chatProcessingMessage');
    if (!processing) return;
    processing.style.display = 'block';
    if (processingMessage) processingMessage.textContent = text || 'å‡¦ç†ä¸­...';
    resetStages();
    updateStage(1, 'processing');
}

function hideProcessing() {
    const processing = document.getElementById('aiChatProcessing');
    if (!processing) return;
    updateStage(1, 'completed');
    updateStage(2, 'completed');
    updateStage(3, 'completed');
    setTimeout(() => {
        processing.style.display = 'none';
    }, 300);
}

function showGeneratedKnowledge(data) {
    let message = `
        âœ… ãƒŠãƒ¬ãƒƒã‚¸ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼<br><br>
        <strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${data.title}<br>
        <strong>ITSMã‚¿ã‚¤ãƒ—:</strong> ${data.itsm_type} (ä¿¡é ¼åº¦: ${Math.round(data.confidence * 100)}%)<br><br>
        <strong>å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong><br>
        <div style="background: #f5f5f5; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; max-height: 200px; overflow-y: auto; white-space: pre-wrap;">${data.content.substring(0, 500)}...</div>
        <br>
        <button onclick="saveKnowledge('${data.title.replace(/'/g, "\\'")}', '${data.itsm_type}')" class="btn btn-primary">ä¿å­˜ã™ã‚‹</button>
        <button onclick="editKnowledge()" class="btn btn-secondary" style="margin-left: 0.5rem;">ç·¨é›†ã™ã‚‹</button>
    `;

    addMessage('assistant', message);
    window.generatedKnowledge = data;
}

async function saveKnowledge(title, itsmType) {
    const data = window.generatedKnowledge;
    try {
        const response = await fetch('/api/chat/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: data.title,
                content: data.content,
                itsm_type: data.itsm_type,
                session_id: sessionId,
                conversation_history: conversationHistory
            })
        });

        const result = await response.json();
        if (result.success) {
            window.location.href = '/knowledge/' + result.knowledge_id + '?success=1&message=AIå¯¾è©±ã§ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä½œæˆã—ã¾ã—ãŸ';
        } else {
            addMessage('assistant', 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        addMessage('assistant', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}

function editKnowledge() {
    const data = window.generatedKnowledge;
    const params = new URLSearchParams({
        title: data.title,
        content: data.content,
        itsm_type: data.itsm_type
    });
    window.location.href = '/knowledge/create?' + params.toString();
}

document.getElementById('newChatBtn').addEventListener('click', () => {
    sessionId = 'session_' + Date.now();
    conversationHistory = [];
    socket.emit('join_chat', { session_id: sessionId });
    document.getElementById('aiChatMessages').innerHTML = `
        <div class="chat-system-message">
            <div class="system-title">ğŸ‘‹ ã“ã‚“ã«ã¡ã¯ï¼</div>
            <p class="system-text">ç¤¾å†…ã®æ‰‹é †ã‚„ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œã«ã¤ã„ã¦ä½•ã§ã‚‚è³ªå•ã—ã¦ãã ã•ã„ã€‚</p>
            <div class="quick-questions">
                <span class="quick-label">ã‚ˆãã‚ã‚‹è³ªå•:</span>
                <div class="quick-buttons">
                    <button class="quick-btn" data-question="VPNæ¥ç¶šãŒã§ããªã„æ™‚ã®å¯¾å‡¦æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„">VPNæ¥ç¶š</button>
                    <button class="quick-btn" data-question="ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒé…ã„æ™‚ã®ç¢ºèªæ‰‹é †ã‚’æ•™ãˆã¦ãã ã•ã„">ãƒ¡ãƒ¼ãƒ«é…å»¶</button>
                    <button class="quick-btn" data-question="çµŒè²»ç²¾ç®—ã®æ‰‹é †ã‚’æ•™ãˆã¦ãã ã•ã„">çµŒè²»ç²¾ç®—</button>
                    <button class="quick-btn" data-question="æœ‰çµ¦ä¼‘æš‡ã®ç”³è«‹æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„">æœ‰çµ¦ä¼‘æš‡</button>
                </div>
            </div>
        </div>
    `;
    document.getElementById('chatHistoryList').innerHTML = '';
    attachQuickButtons();
});

document.getElementById('reloadChatBtn').addEventListener('click', () => {
    document.getElementById('aiChatMessages').scrollTo({ top: 0, behavior: 'smooth' });
});
</script>
{% endblock %}
