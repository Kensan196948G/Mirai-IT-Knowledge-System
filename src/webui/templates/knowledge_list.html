{% extends "base.html" %}

{% block title %}ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ / FAQä¸€è¦§ - Mirai IT Knowledge Systems{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <span aria-hidden="true">ğŸ“š</span> ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ / FAQä¸€è¦§
    </h1>
    <p class="page-description">
        ç¤¾å†…ITãƒŠãƒ¬ãƒƒã‚¸ã¨ã‚ˆãã‚ã‚‹è³ªå•ï¼ˆFAQï¼‰ã‚’ä¸€è¦§è¡¨ç¤º
    </p>
</div>

<!-- æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ -->
<section class="section">
    <div class="card" style="margin-bottom: 1.5rem;">
        <form id="searchForm" method="POST" action="/knowledge/search" role="search">
            <div class="search-box">
                <input
                    type="search"
                    id="searchInput"
                    name="query"
                    placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢..."
                    aria-label="ãƒŠãƒ¬ãƒƒã‚¸ã‚’æ¤œç´¢"
                >
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <select class="form-select" name="itsm_type" aria-label="ITSMã‚¿ã‚¤ãƒ—">
                    <option value="">ã™ã¹ã¦</option>
                    <option value="Incident">ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ</option>
                    <option value="Problem">å•é¡Œç®¡ç†</option>
                    <option value="Change">å¤‰æ›´ç®¡ç†</option>
                    <option value="Release">ãƒªãƒªãƒ¼ã‚¹ç®¡ç†</option>
                    <option value="Request">FAQ/ã‚µãƒ¼ãƒ“ã‚¹ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</option>
                </select>
                <button class="btn btn-primary" type="submit">æ¤œç´¢</button>
            </div>
        </form>
    </div>
</section>

<!-- ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<section class="section" aria-labelledby="knowledge-heading">
    <div class="card">
        <div class="card-header">
            <h2 id="knowledge-heading" class="card-title">
                <span aria-hidden="true">ğŸ“–</span> ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§
                <span style="color: var(--color-text-secondary); font-size: 0.9rem; font-weight: normal;">({{ knowledge_list|length }}ä»¶)</span>
            </h2>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <a href="/knowledge/search?itsm_type=Incident" class="btn btn-sm btn-outline">ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®ã¿</a>
            </div>
        </div>

        <!-- ä¸€æ‹¬æ“ä½œãƒãƒ¼ -->
        <div id="bulkActionsKnowledge" class="bulk-actions">
            <span class="bulk-count"><span id="selectedCountKnowledge">0</span>ä»¶é¸æŠä¸­</span>
            <button class="btn btn-sm" onclick="exportSelected('knowledge')">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <button class="btn btn-sm" onclick="clearSelection('knowledge')">âœ• é¸æŠè§£é™¤</button>
        </div>

        <!-- ã‚½ãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="sort-controls">
            <span class="sort-label">ä¸¦ã³æ›¿ãˆ:</span>
            <button class="sort-btn active desc" data-sort="date" onclick="toggleSort(this, 'knowledge')">
                ğŸ“… æ—¥ä»˜ <span class="sort-icon">â†“</span>
            </button>
            <button class="sort-btn" data-sort="title" onclick="toggleSort(this, 'knowledge')">
                ğŸ“ ã‚¿ã‚¤ãƒˆãƒ« <span class="sort-icon">â†“</span>
            </button>
            <button class="sort-btn" data-sort="type" onclick="toggleSort(this, 'knowledge')">
                ğŸ·ï¸ ã‚¿ã‚¤ãƒ— <span class="sort-icon">â†“</span>
            </button>
        </div>

        <div class="card-body">
            {% if knowledge_list %}
            <div class="content-grid" id="knowledgeGrid">
                {% for knowledge in knowledge_list %}
                <article class="knowledge-card {{ knowledge.itsm_type|lower }}" tabindex="0" role="button" data-id="{{ knowledge.id }}" data-date="{{ knowledge.created_at }}" data-title="{{ knowledge.title }}" data-type="{{ knowledge.itsm_type }}">
                    <div class="card-header">
                        <label class="checkbox-wrapper" onclick="event.stopPropagation();">
                            <input type="checkbox" class="item-checkbox knowledge-checkbox" data-id="{{ knowledge.id }}" onchange="updateBulkActions('knowledge')">
                            <span class="checkmark"></span>
                        </label>
                        <h3 class="card-title" onclick="location.href='/knowledge/{{ knowledge.id }}'">{{ knowledge.title }}</h3>
                        <span class="badge badge-{{ knowledge.itsm_type|lower }}" role="status">
                            {% if knowledge.itsm_type == 'Incident' %}ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ
                            {% elif knowledge.itsm_type == 'Problem' %}å•é¡Œç®¡ç†
                            {% elif knowledge.itsm_type == 'Change' %}å¤‰æ›´ç®¡ç†
                            {% elif knowledge.itsm_type == 'Release' %}ãƒªãƒªãƒ¼ã‚¹ç®¡ç†
                            {% else %}ãã®ä»–{% endif %}
                        </span>
                    </div>
                    <p class="card-summary" onclick="location.href='/knowledge/{{ knowledge.id }}'">
                        {{ (knowledge.summary or knowledge.content)|truncate(100, True) }}
                    </p>
                    <div class="card-footer">
                        {% if knowledge.tags %}
                        <span><span aria-hidden="true">ğŸ·ï¸</span>
                            {% if knowledge.tags is string %}
                                {{ knowledge.tags|truncate(50, True) }}
                            {% else %}
                                {{ knowledge.tags|join(', ')|truncate(50, True) }}
                            {% endif %}
                        </span>
                        {% endif %}
                        <time datetime="{{ knowledge.created_at[:10] if knowledge.created_at else '' }}">
                            {{ knowledge.created_at[:10] if knowledge.created_at else 'æ—¥ä»˜ãªã—' }}
                        </time>
                    </div>
                </article>
                {% endfor %}
            </div>

            <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
            <nav class="pagination" aria-label="ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³" id="knowledgePagination">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </nav>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“­</div>
                <h3>ãƒŠãƒ¬ãƒƒã‚¸ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</h3>
                <p>ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ»å•é¡Œç®¡ç†ãƒ»å¤‰æ›´ç®¡ç†ãªã©ã®ãƒŠãƒ¬ãƒƒã‚¸ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
                <a href="/knowledge/create" class="btn btn-primary" style="margin-top: 1rem;">ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä½œæˆ</a>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- FAQä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<section class="section" aria-labelledby="faq-heading">
    <div class="card">
        <div class="card-header">
            <h2 id="faq-heading" class="card-title">
                <span aria-hidden="true">â“</span> FAQä¸€è¦§ï¼ˆã‚ˆãã‚ã‚‹è³ªå•ï¼‰
                <span style="color: var(--color-text-secondary); font-size: 0.9rem; font-weight: normal;">({{ faq_list|length }}ä»¶)</span>
            </h2>
            <a href="/knowledge/search?itsm_type=Request" class="btn btn-sm btn-outline">ã™ã¹ã¦ã®FAQã‚’è¦‹ã‚‹</a>
        </div>

        <!-- ä¸€æ‹¬æ“ä½œãƒãƒ¼ -->
        <div id="bulkActionsFaq" class="bulk-actions">
            <span class="bulk-count"><span id="selectedCountFaq">0</span>ä»¶é¸æŠä¸­</span>
            <button class="btn btn-sm" onclick="exportSelected('faq')">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <button class="btn btn-sm" onclick="clearSelection('faq')">âœ• é¸æŠè§£é™¤</button>
        </div>

        <div class="card-body">
            {% if faq_list %}
            <div class="content-grid" id="faqGrid">
                {% for faq in faq_list %}
                <article class="knowledge-card request" tabindex="0" role="button" data-id="{{ faq.id }}" data-date="{{ faq.created_at }}" data-title="{{ faq.title }}">
                    <div class="card-header">
                        <label class="checkbox-wrapper" onclick="event.stopPropagation();">
                            <input type="checkbox" class="item-checkbox faq-checkbox" data-id="{{ faq.id }}" onchange="updateBulkActions('faq')">
                            <span class="checkmark"></span>
                        </label>
                        <h3 class="card-title" onclick="location.href='/knowledge/{{ faq.id }}'">{{ faq.title }}</h3>
                        <span class="badge badge-request" role="status">FAQ</span>
                    </div>
                    <p class="card-summary" onclick="location.href='/knowledge/{{ faq.id }}'">
                        {{ (faq.summary or faq.content)|truncate(100, True) }}
                    </p>
                    <div class="card-footer">
                        {% if faq.tags %}
                        <span><span aria-hidden="true">ğŸ·ï¸</span>
                            {% if faq.tags is string %}
                                {{ faq.tags|truncate(50, True) }}
                            {% else %}
                                {{ faq.tags|join(', ')|truncate(50, True) }}
                            {% endif %}
                        </span>
                        {% endif %}
                        <time datetime="{{ faq.created_at[:10] if faq.created_at else '' }}">
                            {{ faq.created_at[:10] if faq.created_at else 'æ—¥ä»˜ãªã—' }}
                        </time>
                    </div>
                </article>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">â“</div>
                <h3>FAQãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</h3>
                <p>ã‚ˆãã‚ã‚‹è³ªå•ã¨ãã®å›ç­”ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
                <a href="/knowledge/create" class="btn btn-primary" style="margin-top: 1rem;">FAQã‚’ä½œæˆ</a>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
<div class="quick-actions-bar">
    <button class="quick-action-btn" data-tooltip="æ–°è¦ä½œæˆ" onclick="location.href='/knowledge/create'" aria-label="æ–°è¦ãƒŠãƒ¬ãƒƒã‚¸ä½œæˆ">
        âœï¸
    </button>
    <button class="quick-action-btn secondary" data-tooltip="ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ" onclick="showKeyboardHelp()" aria-label="ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’è¡¨ç¤º">
        âŒ¨ï¸
    </button>
    <button class="quick-action-btn secondary" data-tooltip="ãƒˆãƒƒãƒ—ã¸" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" aria-label="ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«">
        â†‘
    </button>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
.checkbox-wrapper {
    position: relative;
    display: inline-flex;
    align-items: center;
    cursor: pointer;
    margin-right: 0.5rem;
}

.checkbox-wrapper input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
}

.checkmark {
    height: 18px;
    width: 18px;
    background-color: #fff;
    border: 2px solid var(--color-border);
    border-radius: 4px;
    transition: all 0.2s;
}

.checkbox-wrapper:hover .checkmark {
    border-color: var(--color-primary);
}

.checkbox-wrapper input:checked ~ .checkmark {
    background-color: var(--color-primary);
    border-color: var(--color-primary);
}

.checkmark:after {
    content: "";
    position: absolute;
    display: none;
    left: 6px;
    top: 2px;
    width: 4px;
    height: 8px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.checkbox-wrapper input:checked ~ .checkmark:after {
    display: block;
}

/* ã‚«ãƒ¼ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼èª¿æ•´ */
.knowledge-card .card-header {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
}

.knowledge-card .card-title {
    flex: 1;
    cursor: pointer;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// ä¸€æ‹¬æ“ä½œæ©Ÿèƒ½
function updateBulkActions(type) {
    const checkboxes = document.querySelectorAll(`.${type}-checkbox:checked`);
    const count = checkboxes.length;
    const bulkBar = document.getElementById(`bulkActions${type.charAt(0).toUpperCase() + type.slice(1)}`);
    const countSpan = document.getElementById(`selectedCount${type.charAt(0).toUpperCase() + type.slice(1)}`);

    if (count > 0) {
        bulkBar.classList.add('show');
        countSpan.textContent = count;
    } else {
        bulkBar.classList.remove('show');
    }
}

function clearSelection(type) {
    const checkboxes = document.querySelectorAll(`.${type}-checkbox`);
    checkboxes.forEach(cb => cb.checked = false);
    updateBulkActions(type);
}

function exportSelected(type) {
    const checkboxes = document.querySelectorAll(`.${type}-checkbox:checked`);
    const ids = Array.from(checkboxes).map(cb => cb.dataset.id);

    if (ids.length === 0) {
        showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
        return;
    }

    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    const exportData = ids.map(id => {
        const card = document.querySelector(`[data-id="${id}"]`);
        return {
            id: id,
            title: card.dataset.title,
            date: card.dataset.date,
            type: card.dataset.type || 'FAQ'
        };
    });

    // JSONã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${type}_export_${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);

    showToast(`${ids.length}ä»¶ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');
    clearSelection(type);
}

// ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
function toggleSort(btn, type) {
    const sortBtns = btn.parentElement.querySelectorAll('.sort-btn');
    const isActive = btn.classList.contains('active');

    // ä»–ã®ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    sortBtns.forEach(b => b.classList.remove('active', 'asc', 'desc'));

    // ç¾åœ¨ã®ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
    btn.classList.add('active');
    if (isActive && btn.classList.contains('desc')) {
        btn.classList.add('asc');
        btn.classList.remove('desc');
    } else {
        btn.classList.add('desc');
    }

    // ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
    const grid = document.getElementById(`${type}Grid`);
    const cards = Array.from(grid.querySelectorAll('.knowledge-card'));
    const sortKey = btn.dataset.sort;
    const isDesc = btn.classList.contains('desc');

    cards.sort((a, b) => {
        let valA, valB;

        switch (sortKey) {
            case 'date':
                valA = a.dataset.date || '';
                valB = b.dataset.date || '';
                break;
            case 'title':
                valA = a.dataset.title || '';
                valB = b.dataset.title || '';
                break;
            case 'type':
                valA = a.dataset.type || '';
                valB = b.dataset.type || '';
                break;
            default:
                valA = '';
                valB = '';
        }

        if (valA < valB) return isDesc ? 1 : -1;
        if (valA > valB) return isDesc ? -1 : 1;
        return 0;
    });

    // DOMã‚’æ›´æ–°
    cards.forEach(card => grid.appendChild(card));

    showToast(`${sortKey === 'date' ? 'æ—¥ä»˜' : sortKey === 'title' ? 'ã‚¿ã‚¤ãƒˆãƒ«' : 'ã‚¿ã‚¤ãƒ—'}é †ã§ã‚½ãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'info');
}

// ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¤§é‡ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰
(function() {
    const ITEMS_PER_PAGE = 12;

    function setupPagination(gridId, paginationId) {
        const grid = document.getElementById(gridId);
        if (!grid) return;

        const cards = Array.from(grid.querySelectorAll('.knowledge-card'));
        const totalPages = Math.ceil(cards.length / ITEMS_PER_PAGE);

        if (totalPages <= 1) return;

        let currentPage = 1;

        function showPage(page) {
            currentPage = page;
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;

            cards.forEach((card, index) => {
                card.style.display = (index >= start && index < end) ? '' : 'none';
            });

            renderPagination();
        }

        function renderPagination() {
            const pagination = document.getElementById(paginationId);
            if (!pagination) return;

            let html = '';

            // å‰ã¸ãƒœã‚¿ãƒ³
            html += `<button class="pagination-btn ${currentPage === 1 ? 'disabled' : ''}"
                             onclick="event.preventDefault(); ${gridId}GoToPage(${currentPage - 1})"
                             ${currentPage === 1 ? 'disabled' : ''}>â†</button>`;

            // ãƒšãƒ¼ã‚¸ç•ªå·
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}"
                                     onclick="event.preventDefault(); ${gridId}GoToPage(${i})">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += '<span class="pagination-info">...</span>';
                }
            }

            // æ¬¡ã¸ãƒœã‚¿ãƒ³
            html += `<button class="pagination-btn ${currentPage === totalPages ? 'disabled' : ''}"
                             onclick="event.preventDefault(); ${gridId}GoToPage(${currentPage + 1})"
                             ${currentPage === totalPages ? 'disabled' : ''}>â†’</button>`;

            html += `<span class="pagination-info">${currentPage} / ${totalPages}ãƒšãƒ¼ã‚¸</span>`;

            pagination.innerHTML = html;
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦ç™»éŒ²
        window[`${gridId}GoToPage`] = function(page) {
            if (page >= 1 && page <= totalPages) {
                showPage(page);
                // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };

        // åˆæœŸè¡¨ç¤º
        showPage(1);
    }

    // å„ã‚°ãƒªãƒƒãƒ‰ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
    setupPagination('knowledgeGrid', 'knowledgePagination');
})();
</script>
{% endblock %}
