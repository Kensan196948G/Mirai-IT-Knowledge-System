{% extends "base.html" %}

{% block title %}è¨­å®š - Mirai IT Knowledge Systems{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <div class="breadcrumb-content">
        <a href="/">ãƒ›ãƒ¼ãƒ </a>
        <span class="breadcrumb-separator">â€º</span>
        <span>è¨­å®š</span>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .settings-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .settings-section h3 {
        color: var(--color-primary);
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #eee;
    }

    .setting-item {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .setting-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .setting-label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #333;
    }

    .setting-description {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 0.75rem;
    }

    .auth-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }

    .auth-modal.show {
        display: flex;
    }

    .auth-modal-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .password-field {
        position: relative;
    }

    .password-toggle {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="card" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-left: 4px solid var(--color-primary);">
    <h2>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h2>
    <p style="color: #666;">
        ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œã‚’è¨­å®šã§ãã¾ã™ã€‚è¨­å®šã®ä¿å­˜ã«ã¯ç®¡ç†è€…æ¨©é™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ãŒå¿…è¦ã§ã™ã€‚
    </p>
</div>

<form id="settingsForm" onsubmit="saveSettings(event)">
    <!-- AIè¨­å®š -->
    <div class="settings-section">
        <h3>ğŸ¤– AIè¨­å®š</h3>

        <div class="setting-item">
            <label class="setting-label">AI APIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼</label>
            <div class="setting-description">
                AIå¯¾è©±ãƒ»AIæ¤œç´¢ã§ä½¿ç”¨ã™ã‚‹APIã‚’é¸æŠã—ã¾ã™ã€‚ã€Œãªã—ã€ã®å ´åˆã¯ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã§å‹•ä½œã—ã¾ã™ã€‚
            </div>
            <select style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;" name="ai_provider">
                <option value="none" selected>ãªã—ï¼ˆãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ï¼‰</option>
                <option value="anthropic">Anthropic Claudeï¼ˆæ¨å¥¨ï¼‰</option>
                <option value="openrouter">OpenRouterï¼ˆè¤‡æ•°ãƒ¢ãƒ‡ãƒ«å¯¾å¿œï¼‰</option>
                <option value="openai">OpenAI GPT</option>
                <option value="deepseek">DeepSeekï¼ˆä½ã‚³ã‚¹ãƒˆï¼‰</option>
            </select>
        </div>

        <div class="setting-item" id="apiKeySettings" style="display: none;">
            <label class="setting-label">API ã‚­ãƒ¼</label>
            <div class="setting-description">
                é¸æŠã—ãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
            </div>
            <div class="password-field">
                <input type="password" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;" name="api_key" placeholder="sk-...">
                <span class="password-toggle" onclick="togglePassword(this)">ğŸ‘ï¸</span>
            </div>
        </div>

        <div class="setting-item" id="chatModelSettings" style="display: none;">
            <label class="setting-label">AIå¯¾è©±ç”¨ãƒ¢ãƒ‡ãƒ«</label>
            <div class="setting-description">
                AIå¯¾è©±ãƒŠãƒ¬ãƒƒã‚¸ä½œæˆã§ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«
            </div>
            <select style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;" name="ai_model_chat" id="chatModelSelect">
                <!-- Anthropicç”¨ -->
                <optgroup label="Anthropic Claude" data-provider="anthropic">
                    <option value="anthropic/claude-sonnet-4.5">Claude Sonnet 4.5ï¼ˆæœ€æ–°ãƒ»æœ€é«˜å“è³ªï¼‰</option>
                    <option value="anthropic/claude-haiku-4.5">Claude Haiku 4.5ï¼ˆé«˜é€Ÿãƒ»ãƒãƒ©ãƒ³ã‚¹ï¼‰</option>
                </optgroup>
                <!-- OpenAIç”¨ -->
                <optgroup label="OpenAI GPT" data-provider="openai">
                    <option value="openai/gpt-5.2">GPT-5.2ï¼ˆæœ€æ–°ï¼‰</option>
                    <option value="openai/gpt-5.1">GPT-5.1</option>
                </optgroup>
                <!-- DeepSeekç”¨ -->
                <optgroup label="DeepSeek" data-provider="deepseek">
                    <option value="deepseek/deepseek-v3.2">DeepSeek V3.2ï¼ˆæœ€æ–°ãƒ»ä½ã‚³ã‚¹ãƒˆï¼‰</option>
                    <option value="deepseek/deepseek-chat-v3.1">DeepSeek Chat V3.1</option>
                </optgroup>
                <!-- OpenRouterç”¨ï¼ˆå…¨ã¦ï¼‰ -->
                <optgroup label="OpenRouter - Anthropic" data-provider="openrouter">
                    <option value="anthropic/claude-sonnet-4.5">Claude Sonnet 4.5ï¼ˆæœ€æ–°ãƒ»æœ€é«˜å“è³ªï¼‰</option>
                    <option value="anthropic/claude-haiku-4.5">Claude Haiku 4.5ï¼ˆé«˜é€Ÿãƒ»ãƒãƒ©ãƒ³ã‚¹ï¼‰</option>
                </optgroup>
                <optgroup label="OpenRouter - OpenAI" data-provider="openrouter">
                    <option value="openai/gpt-5.2">GPT-5.2ï¼ˆæœ€æ–°ï¼‰</option>
                    <option value="openai/gpt-5.1">GPT-5.1</option>
                </optgroup>
                <optgroup label="OpenRouter - DeepSeek" data-provider="openrouter">
                    <option value="deepseek/deepseek-v3.2">DeepSeek V3.2ï¼ˆæœ€æ–°ãƒ»ä½ã‚³ã‚¹ãƒˆï¼‰</option>
                    <option value="deepseek/deepseek-chat-v3.1">DeepSeek Chat V3.1ï¼ˆæœ€å®‰ï¼‰</option>
                </optgroup>
            </select>
        </div>

        <div class="setting-item" id="searchModelSettings" style="display: none;">
            <label class="setting-label">AIæ¤œç´¢ç”¨ãƒ¢ãƒ‡ãƒ«</label>
            <div class="setting-description">
                ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆæ¤œç´¢ã§ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ï¼ˆé«˜é€Ÿãªãƒ¢ãƒ‡ãƒ«ã‚’æ¨å¥¨ï¼‰
            </div>
            <select style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;" name="ai_model_search" id="searchModelSelect">
                <!-- Anthropicç”¨ -->
                <optgroup label="Anthropic Claude" data-provider="anthropic">
                    <option value="anthropic/claude-sonnet-4.5">Claude Sonnet 4.5ï¼ˆæœ€é«˜å“è³ªï¼‰</option>
                    <option value="anthropic/claude-haiku-4.5">Claude Haiku 4.5ï¼ˆæ¨å¥¨ãƒ»é«˜é€Ÿï¼‰</option>
                </optgroup>
                <!-- OpenAIç”¨ -->
                <optgroup label="OpenAI GPT" data-provider="openai">
                    <option value="openai/gpt-5.2">GPT-5.2ï¼ˆæœ€æ–°ï¼‰</option>
                    <option value="openai/gpt-5.1">GPT-5.1</option>
                </optgroup>
                <!-- DeepSeekç”¨ -->
                <optgroup label="DeepSeek" data-provider="deepseek">
                    <option value="deepseek/deepseek-v3.2">DeepSeek V3.2ï¼ˆæœ€æ–°ï¼‰</option>
                    <option value="deepseek/deepseek-chat-v3.1">DeepSeek Chat V3.1ï¼ˆæœ€å®‰ãƒ»æ¨å¥¨ï¼‰</option>
                </optgroup>
                <!-- OpenRouterç”¨ï¼ˆå…¨ã¦ï¼‰ -->
                <optgroup label="OpenRouter - Anthropic" data-provider="openrouter">
                    <option value="anthropic/claude-sonnet-4.5">Claude Sonnet 4.5ï¼ˆæœ€é«˜å“è³ªï¼‰</option>
                    <option value="anthropic/claude-haiku-4.5">Claude Haiku 4.5ï¼ˆæ¨å¥¨ãƒ»é«˜é€Ÿï¼‰</option>
                </optgroup>
                <optgroup label="OpenRouter - OpenAI" data-provider="openrouter">
                    <option value="openai/gpt-5.2">GPT-5.2ï¼ˆæœ€æ–°ï¼‰</option>
                    <option value="openai/gpt-5.1">GPT-5.1</option>
                </optgroup>
                <optgroup label="OpenRouter - DeepSeek" data-provider="openrouter">
                    <option value="deepseek/deepseek-v3.2">DeepSeek V3.2ï¼ˆä½ã‚³ã‚¹ãƒˆï¼‰</option>
                    <option value="deepseek/deepseek-chat-v3.1">DeepSeek Chat V3.1ï¼ˆæœ€å®‰ï¼‰</option>
                </optgroup>
            </select>
        </div>
    </div>

    <!-- ã‚·ã‚¹ãƒ†ãƒ è¨­å®š -->
    <div class="settings-section">
        <h3>ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>

        <div class="setting-item">
            <label class="setting-label">1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®è¡¨ç¤ºä»¶æ•°</label>
            <div class="setting-description">
                æ¤œç´¢çµæœã‚„ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ã®1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®è¡¨ç¤ºä»¶æ•°
            </div>
            <input type="number" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;" name="items_per_page" value="50" min="10" max="100">
        </div>

        <div class="setting-item">
            <label class="setting-label">è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</label>
            <div class="setting-description">
                æ¯æ—¥è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™
            </div>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="auto_backup_enabled" checked>
                <span>è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æœ‰åŠ¹åŒ–</span>
            </label>
        </div>
    </div>

    <!-- UIè¨­å®š -->
    <div class="settings-section">
        <h3>ğŸ¨ UIè¨­å®š</h3>

        <div class="setting-item">
            <label class="setting-label">ãƒ†ãƒ¼ãƒ</label>
            <div class="setting-description">
                ç”»é¢ã®é…è‰²ãƒ†ãƒ¼ãƒï¼ˆãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šï¼‰
            </div>
            <select style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;" name="theme">
                <option value="light" selected>ãƒ©ã‚¤ãƒˆ</option>
                <option value="dark" disabled>ãƒ€ãƒ¼ã‚¯ï¼ˆæº–å‚™ä¸­ï¼‰</option>
            </select>
        </div>

        <div class="setting-item">
            <label class="setting-label">ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª¬æ˜</label>
            <div class="setting-description">
                ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸‹éƒ¨ã®èª¬æ˜ãƒãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã©ã†ã‹
            </div>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="show_menu_descriptions" checked>
                <span>ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª¬æ˜ã‚’è¡¨ç¤º</span>
            </label>
        </div>

        <div class="setting-item">
            <label class="setting-label">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</label>
            <div class="setting-description">
                ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆ/, n, ? ãªã©ï¼‰ã‚’æœ‰åŠ¹åŒ–
            </div>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="keyboard_shortcuts_enabled" checked>
                <span>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’æœ‰åŠ¹åŒ–</span>
            </label>
        </div>
    </div>

    <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š -->
    <div class="settings-section">
        <h3>ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</h3>

        <div class="setting-item">
            <label class="setting-label">ãƒŠãƒ¬ãƒƒã‚¸ä½œæˆã®èªè¨¼</label>
            <div class="setting-description">
                ãƒŠãƒ¬ãƒƒã‚¸ä½œæˆæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚’å¿…é ˆã¨ã™ã‚‹ã‹ã©ã†ã‹
            </div>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="require_auth_for_create">
                <span>ãƒŠãƒ¬ãƒƒã‚¸ä½œæˆã«èªè¨¼ã‚’å¿…é ˆã¨ã™ã‚‹</span>
            </label>
        </div>

        <div class="setting-item">
            <label class="setting-label">ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</label>
            <div class="setting-description">
                ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ï¼ˆåˆ†ï¼‰
            </div>
            <input type="number" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;" name="session_timeout_minutes" value="60" min="5" max="1440">
        </div>
    </div>

    <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
    <div style="text-align: center; padding: 2rem 0;">
        <button type="submit" class="btn" style="padding: 1rem 3rem; font-size: 1.1rem;">
            ğŸ’¾ è¨­å®šã‚’ä¿å­˜
        </button>
        <a href="/" class="btn btn-secondary" style="margin-left: 1rem; padding: 1rem 2rem;">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </a>
    </div>
</form>

<!-- èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="authModal" class="auth-modal">
    <div class="auth-modal-content">
        <h3 style="color: var(--color-primary); margin-bottom: 1.5rem;">ğŸ” èªè¨¼ãŒå¿…è¦ã§ã™</h3>
        <p style="color: #666; margin-bottom: 1.5rem; font-size: 0.9rem;">
            è¨­å®šã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€ç®¡ç†è€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
        </p>

        <form id="authForm" onsubmit="authenticate(event)">
            <div class="form-group">
                <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                <input type="text" id="authUsername" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;" required placeholder="admin">
            </div>

            <div class="form-group">
                <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <div class="password-field">
                    <input type="password" id="authPassword" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;" required placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    <span class="password-toggle" onclick="togglePassword(this)">ğŸ‘ï¸</span>
                </div>
            </div>

            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="btn" style="flex: 1;">èªè¨¼ã—ã¦ä¿å­˜</button>
                <button type="button" class="btn btn-secondary" onclick="closeAuthModal()" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </form>

        <div id="authError" style="color: #f44336; margin-top: 1rem; display: none; font-size: 0.9rem;"></div>
    </div>
</div>

<!-- ãƒ’ãƒ³ãƒˆ -->
<div class="card" style="background: #fffbf0; border-left: 4px solid #ffa726;">
    <h4 style="color: #f57c00; margin-bottom: 1rem;">ğŸ’¡ è¨­å®šã®ãƒ’ãƒ³ãƒˆ</h4>
    <ul style="line-height: 2; color: #666; margin-left: 1.5rem;">
        <li><strong>AI APIä¸è¦</strong>: ã€Œãªã—ã€ã‚’é¸æŠã™ã‚Œã°ã€APIã‚­ãƒ¼ãªã—ã§åŸºæœ¬æ©Ÿèƒ½ãŒä½¿ãˆã¾ã™</li>
        <li><strong>æ¨å¥¨API</strong>: OpenRouter + Claude & DeepSeek ã®çµ„ã¿åˆã‚ã›ãŒã‚³ã‚¹ãƒ‘æœ€é«˜</li>
        <li><strong>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç®¡ç†è€…</strong>: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€Œadminã€/ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€Œadmin123ã€ï¼ˆå¤‰æ›´æ¨å¥¨ï¼‰</li>
        <li><strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</strong>: æœ¬ç•ªç’°å¢ƒã§ã¯å¿…ãšç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„</li>
        <li><strong>è¨­å®šå¤‰æ›´å±¥æ­´</strong>: å…¨ã¦ã®å¤‰æ›´ã¯è‡ªå‹•çš„ã«è¨˜éŒ²ã•ã‚Œã¾ã™</li>
    </ul>
</div>

<script>
// AI provideré¸æŠæ™‚ã«APIã‚­ãƒ¼å…¥åŠ›æ¬„ã¨ãƒ¢ãƒ‡ãƒ«é¸æŠã‚’è¡¨ç¤º/éè¡¨ç¤º
document.querySelector('select[name="ai_provider"]').addEventListener('change', function(e) {
    const provider = e.target.value;
    const apiKeySettings = document.getElementById('apiKeySettings');
    const chatModelSettings = document.getElementById('chatModelSettings');
    const searchModelSettings = document.getElementById('searchModelSettings');

    if (provider === 'none') {
        apiKeySettings.style.display = 'none';
        chatModelSettings.style.display = 'none';
        searchModelSettings.style.display = 'none';
    } else {
        apiKeySettings.style.display = 'block';
        chatModelSettings.style.display = 'block';
        searchModelSettings.style.display = 'block';

        // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«å¿œã˜ã¦ãƒ¢ãƒ‡ãƒ«é¸æŠè‚¢ã‚’ãƒ•ã‚£ãƒ«ã‚¿
        filterModelOptions('chatModelSelect', provider);
        filterModelOptions('searchModelSelect', provider);
    }
});

// ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«å¿œã˜ã¦ãƒ¢ãƒ‡ãƒ«é¸æŠè‚¢ã‚’ãƒ•ã‚£ãƒ«ã‚¿
function filterModelOptions(selectId, provider) {
    const select = document.getElementById(selectId);
    const optgroups = select.querySelectorAll('optgroup');

    optgroups.forEach(optgroup => {
        const groupProvider = optgroup.getAttribute('data-provider');

        if (provider === 'openrouter') {
            // OpenRouterã®å ´åˆã¯å…¨ã¦è¡¨ç¤º
            optgroup.style.display = '';
        } else if (groupProvider === provider) {
            // é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã¿è¡¨ç¤º
            optgroup.style.display = '';
        } else {
            // ä»–ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¯éè¡¨ç¤º
            optgroup.style.display = 'none';
        }
    });

    // æœ€åˆã®è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•é¸æŠ
    const firstVisibleOption = select.querySelector('optgroup:not([style*="display: none"]) option');
    if (firstVisibleOption) {
        select.value = firstVisibleOption.value;
    }
}

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
function togglePassword(element) {
    const input = element.previousElementSibling;
    if (input.type === 'password') {
        input.type = 'text';
        element.textContent = 'ğŸ™ˆ';
    } else {
        input.type = 'password';
        element.textContent = 'ğŸ‘ï¸';
    }
}

// è¨­å®šä¿å­˜ï¼ˆèªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
function saveSettings(event) {
    event.preventDefault();
    document.getElementById('authModal').classList.add('show');
}

// èªè¨¼å‡¦ç†
async function authenticate(event) {
    event.preventDefault();

    const username = document.getElementById('authUsername').value;
    const password = document.getElementById('authPassword').value;
    const authError = document.getElementById('authError');

    authError.style.display = 'none';

    try {
        // èªè¨¼APIå‘¼ã³å‡ºã—
        const authResponse = await fetch('/api/settings/authenticate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username, password })
        });

        const authData = await authResponse.json();

        if (authData.success) {
            // èªè¨¼æˆåŠŸ â†’ è¨­å®šã‚’ä¿å­˜
            await saveSettingsToServer(authData.token);
        } else {
            authError.textContent = 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
            authError.style.display = 'block';
        }
    } catch (error) {
        authError.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
        authError.style.display = 'block';
    }
}

// å®Ÿéš›ã®è¨­å®šä¿å­˜
async function saveSettingsToServer(authToken) {
    const formData = new FormData(document.getElementById('settingsForm'));
    const settings = {};

    for (let [key, value] of formData.entries()) {
        settings[key] = value;
    }

    try {
        const response = await fetch('/api/settings/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + authToken
            },
            body: JSON.stringify({ settings })
        });

        const data = await response.json();

        if (data.success) {
            closeAuthModal();
            showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        document.getElementById('authError').textContent = 'âŒ ' + error.message;
        document.getElementById('authError').style.display = 'block';
    }
}

function closeAuthModal() {
    document.getElementById('authModal').classList.remove('show');
    document.getElementById('authUsername').value = '';
    document.getElementById('authPassword').value = '';
    document.getElementById('authError').style.display = 'none';
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('authModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAuthModal();
    }
});
</script>
{% endblock %}
